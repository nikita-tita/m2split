# Модель данных - Табличное представление

## Лист 1: Модель данных

| Сущность/поле               | Тип           | Описание                                       | Этапы/видимость            | R/W по ролям                                                        |
| --------------------------- | ------------- | ---------------------------------------------- | -------------------------- | ------------------------------------------------------------------- |
| DEAL.id                     | UUID          | Идентификатор сделки                           | Везде                      | R: все участники                                                    |
| DEAL.status                 | enum          | draft/in_registry/approved/sent/paid/cancelled | Везде                      | W: М2 (тех), Застройщик (approve/reject); R: остальные              |
| DEAL.initiator_role         | enum          | Роль инициатора                                | Везде                      | R-only: все                                                         |
| DEAL.initiator_party_id     | string        | ID организации инициатора                      | Везде                      | R-only: все                                                         |
| DEAL.initiator_user_id      | string        | Создатель записи                               | Везде                      | R-only: все                                                         |
| DEAL.initiator_timestamp    | datetime      | Время создания сделки                          | Везде                      | R-only: все                                                         |
| DEAL.parties[]              | array         | Стороны: застройщик/АН/агенты                  | Везде                      | W: М2, АН-админ (свои); R: остальные                                |
| DEAL.object                 | struct        | Объект/лот/адрес                               | Везде                      | W: М2; R: все                                                       |
| DEAL.shares[]               | array         | Доли: party/role/pct/amount                    | Draft, In_registry         | W: М2; R: все; после approved — R-only                              |
| DEAL.contract_basis         | string        | Основание: договор/оферта №/дата               | Везде                      | W: М2, Застройщик; R: остальные                                     |
| REGISTRY.id                 | UUID          | Idempotency key реестра                        | С момента создания реестра | W: М2; R: участники                                                 |
| REGISTRY.items[].payee      | string        | Получатель (имя/организация)                   | In_registry → Paid         | W: М2 до approve; далее R-only; получатель видит только себя        |
| REGISTRY.items[].tin        | string        | ИНН получателя (10/12)                         | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| REGISTRY.items[].acc        | string        | Р/с получателя (20)                            | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| REGISTRY.items[].bic        | string        | БИК банка (9)                                  | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| REGISTRY.items[].amount_rub | decimal(18,2) | Сумма выплаты                                  | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| REGISTRY.items[].vat_flag   | enum          | Режим: VAT/USN/NPD                             | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| REGISTRY.items[].vat_rate   | int           | Ставка НДС: 0/10/20/22                         | In_registry → Paid         | W: М2 до approve; R-only далее (обяз. при VAT)                      |
| REGISTRY.items[].doc_basis  | string        | Основание строки (№/дата)                      | In_registry → Paid         | W: М2 до approve; R-only далее                                      |
| BANK.order_id               | string        | ID распоряжения в банке                        | Approved → Paid            | W: системно; R: участники                                           |
| BANK.statuses[]             | array         | Журнал статусов банка                          | Sent → Paid                | W: системно; R: участники                                           |
| DOCS.primary[]              | array         | Акт/сч-ф/чек НПД                               | После выплат               | Upload: Исполнитель; Компоновка: М2; Download: Застройщик/бух/юрист |
| M2.invoice                  | struct        | Счет/акт М2 за сервис                          | После периода/сделки       | W: М2; R: Застройщик/бух/юрист                                      |

## Лист 2: ACL по стадиям

| Объект                | Draft                 | In_registry                 | Approved | Sent_to_bank   | Paid       |
| --------------------- | --------------------- | --------------------------- | -------- | -------------- | ---------- |
| Сделка (поля)         | W: М2/АН-админ (свои) | R                           | R        | R              | R          |
| Доли                  | W: М2                 | R                           | R        | R              | R          |
| Реестр                | —                     | W: М2 / Approve: Застройщик | R        | R              | R          |
| Выплаты/статусы банка | —                     | —                           | R        | R              | R          |
| Первичка исполнителей | —                     | —                           | —        | Upload/Collect | R/Download |
| Счет М2 за сервис     | —                     | —                           | —        | —              | Issue/Pay  |

## Лист 3: Экран — Сделка

| Секция/поле | Состав                                                      | Этап              | Правила/валидации                                                               |
| ----------- | ----------------------------------------------------------- | ----------------- | ------------------------------------------------------------------------------- |
| Шапка       | ID, статус, Инициатор (роль/орг/пользователь/время), объект | Везде             | Инициатор — read-only всем; статус меняют только М2/Застройщик (approve/reject) |
| Стороны     | Застройщик, АН, Агенты (справочник контрагентов)            | Draft             | W: М2/АН-админ (свои); обязательны ИНН/р/с/БИК                                  |
| Доли        | party/role/pct/amount; сумма долей=100%                     | Draft/In_registry | Жесткая валидация сумм; после approve — read-only                               |
| Основание   | Договор/оферта №/дата/ссылка                                | Везде             | Обязательное поле; формат проверяется                                           |
| История     | Журнал изменений (кто/что было→стало)                       | Везде             | Автоматически                                                                   |
| Действия    | Создать реестр / Отправить на утверждение                   | Draft/In_registry | Доступно при: доли=100%, реквизиты валидны                                      |

## Лист 4: Экран — Реестр

| Раздел          | Состав/поля                                               | Этап                 | Правила/валидаторы                                                |
| --------------- | --------------------------------------------------------- | -------------------- | ----------------------------------------------------------------- |
| Список          | №, дата, сумма, кол-во строк, статус, автор               | Всегда               | Фильтры: период, статус, застройщик, режим НДС получателей        |
| Строка реестра  | payee, ИНН, р/с, БИК, сумма, режим, ставка НДС, основание | Черновик             | Форматы ИНН/р/с/БИК; сумма>0; ставка НДС при VAT; doc_basis обяз. |
| Импорт          | Из сделок/карточек долей                                  | Черновик             | Проверка соответствия сумм                                        |
| Утверждение     | Просмотр сводки, комментарии                              | На утверждении       | Approve/Reject застройщиком                                       |
| Отправка в банк | Распоряжение + реестр (JSON/XML), подписание              | Утвержден            | Idempotency по REGISTRY.id; лог квитанций                         |
| Статусы банка   | Принято/обработке/зачислено/ошибка                        | Отправлен → Исполнен | Повтор по строке (если позволяет политика)                        |
| Первичка        | Акт/сч-ф (АН/НДС), акт (УСН), чек НПД                     | После выплат         | Сбор и компоновка в пакет для застройщика                         |
| Экспорт         | CSV/JSON (банк), XLS (согласование)                       | Всегда               | Структура = модели данных                                         |

---

## Примечания

**Условные обозначения:**
- **R** - Read (чтение)
- **W** - Write (запись)
- **R-only** - Только чтение (неизменяемое)
- **—** - Недоступно на данном этапе

**Роли:**
- **Застройщик** - Застройщик-Админ
- **М2** - М2-Оператор
- **АН-админ** - АН-Админ
- **Агент/ИП/НПД** - Исполнители
- **Бух/юрист** - Бухгалтер/Юрист застройщика

**Стадии:**
- **Draft** - Черновик
- **In_registry** - В реестре
- **Approved** - Утверждено
- **Sent_to_bank** - Отправлено в банк
- **Paid** - Выплачено

---

## Использование

Эти таблицы можно скопировать в Excel/Google Sheets:
1. Каждая секция = отдельный лист
2. Используйте автофильтры для поиска
3. Цветовое кодирование по статусам помогает визуально

**Для импорта в БД:**
- Колонка "Тип" содержит SQL-типы
- Колонка "R/W по ролям" - для создания RBAC правил
- Колонка "Правила/валидации" - для backend валидаторов
