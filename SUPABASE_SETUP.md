# üöÄ Supabase Setup Guide - M2 Split

–ü–æ–ª–Ω—ã–π –≥–∞–π–¥ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è M2 Split –∑–∞ 5 –º–∏–Ω—É—Ç.

## üìã –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
- ‚úÖ Postgres –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å 7 —Ç–∞–±–ª–∏—Ü–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ timestamps –∏ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ Sample data (5 –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤)
- ‚úÖ TypeScript —Ç–∏–ø—ã –¥–ª—è type-safe –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ì–æ—Ç–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î

## –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç Supabase

### 1.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
1. –û—Ç–∫—Ä–æ–π—Ç–µ [https://supabase.com](https://supabase.com)
2. –ù–∞–∂–º–∏—Ç–µ **Start your project** ‚Üí Sign up with GitHub
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ GitHub

### 1.2 –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
1. –ù–∞–∂–º–∏—Ç–µ **New Project**
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   - **Name**: `m2split`
   - **Database Password**: –ø—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å (—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ!)
   - **Region**: `Europe West (Frankfurt)` (–±–ª–∏–∂–∞–π—à–∏–π –∫ –†–§)
   - **Pricing Plan**: `Free` ‚úÖ (500 MB, 2 CPU)
3. –ù–∞–∂–º–∏—Ç–µ **Create new project**
4. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–∑–¥–∞–Ω–∏—è (1-2 –º–∏–Ω—É—Ç—ã) ‚è≥

## –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

### 2.1 –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor
1. –í –ª–µ–≤–æ–º –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ **SQL Editor**
2. –ù–∞–∂–º–∏—Ç–µ **New query**

### 2.2 –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `supabase/migrations/001_initial_schema.sql`
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º—ã–π (Cmd+A, Cmd+C)
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor (Cmd+V)
4. –ù–∞–∂–º–∏—Ç–µ **Run** –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ `Cmd+Enter` (Mac) / `Ctrl+Enter` (Windows)
5. –î–æ–∂–¥–∏—Ç–µ—Å—å —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚úÖ

### 2.3 –ü—Ä–æ–≤–µ—Ä–∫–∞
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Table Editor** (–ª–µ–≤–æ–µ –º–µ–Ω—é)
2. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å 7 —Ç–∞–±–ª–∏—Ü:
   - `counterparties` (5 rows) ‚úÖ
   - `deals` (0 rows)
   - `deal_participants` (0 rows)
   - `registries` (0 rows)
   - `registry_items` (0 rows)
   - `payments` (0 rows)
   - `documents` (0 rows)

## –®–∞–≥ 3: –ü–æ–ª—É—á–∏—Ç–µ credentials

### 3.1 –ù–∞–π–¥–∏—Ç–µ API –∫–ª—é—á–∏
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Project Settings** (‚öôÔ∏è –∏–∫–æ–Ω–∫–∞ –≤ –ª–µ–≤–æ–º –º–µ–Ω—é)
2. –í—ã–±–µ—Ä–∏—Ç–µ **API** –≤ –ø–æ–¥–º–µ–Ω—é
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ:
   - **Project URL**: `https://xxx.supabase.co`
   - **anon public key**: (–¥–ª–∏–Ω–Ω—ã–π JWT —Ç–æ–∫–µ–Ω)

### 3.2 –°–æ–∑–¥–∞–π—Ç–µ .env.local
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ example —Ñ–∞–π–ª:
   ```bash
   cp .env.local.example .env.local
   ```

2. –û—Ç–∫—Ä–æ–π—Ç–µ `.env.local` –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ credentials:
   ```env
   NEXT_PUBLIC_SUPABASE_URL=https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç-id.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=–≤–∞—à-anon-–∫–ª—é—á
   ```

### 3.3 –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
npm run dev
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í –∫–æ–Ω—Å–æ–ª–∏ –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å warning –æ Supabase credentials.

## ‚úÖ –ì–æ—Ç–æ–≤–æ! –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫
–§–æ—Ä–º–∞ `/deals/new` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:
```typescript
await dealsService.createDeal({
  objectName: "–ñ–ö –°–æ–ª–Ω–µ—á–Ω—ã–π",
  totalAmount: 15000000,
  shares: [
    { counterpartyId: "...", sharePercent: 60, amount: 9000000 },
    { counterpartyId: "...", sharePercent: 40, amount: 6000000 }
  ]
});
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è
- –î–æ–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–æ–≤–Ω–æ 100%
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞

### 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
–°–ø–∏—Å–∫–∏ –≥—Ä—É–∑—è—Ç—Å—è –∏–∑ –ë–î:
```typescript
const deals = await dealsService.getDeals({ status: 'draft' });
const counterparties = await counterpartiesService.getCounterparties();
```

### 4. Fallback –Ω–∞ mock-–¥–∞–Ω–Ω—ã–µ
–ï—Å–ª–∏ Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (mock data).

## üîß Troubleshooting

### –û—à–∏–±–∫–∞ "relation does not exist"
**–ü—Ä–∏—á–∏–Ω–∞:** –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏.

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ SQL Editor
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–µ
3. –£–¥–∞–ª–∏—Ç–µ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ

### –û—à–∏–±–∫–∞ "Invalid API key"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π anon key –≤ `.env.local`.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ **anon public** –∫–ª—é—á, –∞ –Ω–µ service role
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –≤ `.env.local`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server

### Warning "Supabase credentials not found"
**–ü—Ä–∏—á–∏–Ω–∞:** `.env.local` –Ω–µ —Å–æ–∑–¥–∞–Ω –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `.env.local` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `NEXT_PUBLIC_`)
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ dev server

### –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** Supabase RLS (Row Level Security) –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ **Table Editor** ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É
2. –ù–∞–∂–º–∏—Ç–µ **RLS disabled** (–¥–ª—è MVP –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å)
3. –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –≤ **Authentication** ‚Üí **Policies**

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –°–≤—è–∑–∏ |
|---------|----------|-------|
| `counterparties` | –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã (–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏, –ê–ù, –∞–≥–µ–Ω—Ç—ã) | - |
| `deals` | –°–¥–µ–ª–∫–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º | ‚Üí counterparties (developer) |
| `deal_participants` | –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–¥–µ–ª–æ–∫ (—Å–ø–ª–∏—Ç –¥–æ–ª–µ–π) | ‚Üí deals, ‚Üí counterparties |
| `registries` | –†–µ–µ—Å—Ç—Ä—ã –≤—ã–ø–ª–∞—Ç | - |
| `registry_items` | –°—Ç—Ä–æ–∫–∏ —Ä–µ–µ—Å—Ç—Ä–æ–≤ | ‚Üí registries, ‚Üí counterparties |
| `payments` | –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–ª–∞—Ç | ‚Üí registries, ‚Üí registry_items |
| `documents` | –ü–µ—Ä–≤–∏—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã | ‚Üí payments, ‚Üí counterparties |

### –í–∞–∂–Ω—ã–µ –ø–æ–ª—è

**counterparties:**
- `type`: developer | agency | agent | ip | npd
- `tax_regime`: VAT | USN | NPD
- `offer_accepted`: Boolean (–¥–ª—è –∞–∫—Ü–µ–ø—Ç–∞ –æ—Ñ–µ—Ä—Ç—ã)

**deals:**
- `status`: draft | in_progress | in_registry | approved | sent_to_bank | paid
- `initiator_*`: –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ–ª—è –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ —Å–¥–µ–ª–∫–∏

**deal_participants:**
- `share_percent`: Decimal(5,2) - –¥–æ–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
- `amount`: BIGINT - —Å—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–¥–ª—è production)

### Row Level Security (RLS)
–í production –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç–µ RLS:
```sql
-- –í–∫–ª—é—á–∏—Ç—å RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
ALTER TABLE deals ENABLE ROW LEVEL SECURITY;

-- –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É (–ø—Ä–∏–º–µ—Ä)
CREATE POLICY "Users can view own deals"
  ON deals FOR SELECT
  USING (auth.uid() = responsible_user_id);
```

### Service Role Key
**–ù–ò–ö–û–ì–î–ê** –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ service role key –≤ client-side –∫–æ–¥–µ!
- Service role key ‚Üí —Ç–æ–ª—å–∫–æ –¥–ª—è server-side API
- Anon public key ‚Üí –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Supabase Docs](https://supabase.com/docs)
- [SQL Reference](https://supabase.com/docs/guides/database)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [TypeScript Support](https://supabase.com/docs/guides/api/generating-types)

## üÜò –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [Supabase Status](https://status.supabase.com)
2. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ [Supabase Discord](https://discord.supabase.com)
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –¢–µ–ø–µ—Ä—å M2 Split —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–∞—Å—Ç–æ—è—â–µ–π –ë–î.
