(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[480],{6655:function(e,t,a){Promise.resolve().then(a.bind(a,8586))},8586:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return C}});var r=a(7437),n=a(2265),s=a(824),i=a(9178),l=a(4226),c=a(8068),o=a(9379),d=a(2489);function u(e){let{isOpen:t,onClose:a,title:n,children:s}=e;return t?(0,r.jsx)("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:(0,r.jsxs)("div",{className:"flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0",children:[(0,r.jsx)("div",{className:"fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75",onClick:a}),(0,r.jsx)("div",{className:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full",children:(0,r.jsxs)("div",{className:"bg-white px-6 pt-5 pb-4",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:n}),(0,r.jsx)("button",{onClick:a,className:"text-gray-400 hover:text-gray-500",children:(0,r.jsx)(d.Z,{className:"w-6 h-6"})})]}),s]})})]})}):null}var p=a(5930),m=a(9397),h=a(1817),x=a(1671),f=a(5868),y=a(1384),b=a(9057),j=a(8509),g=a(3702),v=a(8332),N=a(9280),k=a(2097);function C(){let{currentRole:e}=(0,k.o)(),[t,a]=(0,n.useState)([]),[d,C]=(0,n.useState)(!0),[w,E]=(0,n.useState)(!1),[D,A]=(0,n.useState)(!1),[_,O]=(0,n.useState)(null),[R,T]=(0,n.useState)({type:"AGENT",name:"",inn:"",kpp:"",accountNumber:"",bik:"",bankName:"",email:"",phone:""});(0,n.useEffect)(()=>{I()},[]);let I=async()=>{try{C(!0);let e=await b.f.getCounterparties();a(e)}catch(e){console.error("Failed to load contractors:",e)}finally{C(!1)}},S=e=>{O(e.id),T({type:e.type,name:e.name,inn:e.inn,kpp:e.kpp||"",accountNumber:e.accountNumber||"",bik:e.bik||"",bankName:e.bankName||"",email:e.email||"",phone:e.phone||""}),A(!0)},P=async t=>{t.preventDefault(),E(!0);try{let t;let a={type:R.type,name:R.name,inn:R.inn,kpp:R.kpp||void 0,accountNumber:R.accountNumber||void 0,bik:R.bik||void 0,bankName:R.bankName||void 0,email:R.email||void 0,phone:R.phone||void 0};_?(await b.f.updateCounterparty(_,a),t=_,await j.W.logEvent({type:"CONTRACTOR_UPDATED",entityType:"CONTRACTOR",entityId:t,userId:"2",userName:"Current User",userRole:e,description:"Контрагент обновлён: ".concat(R.name),metadata:{name:R.name,inn:R.inn,type:R.type}})):(t=(await b.f.createCounterparty(a)).id,await j.W.logEvent({type:"CONTRACTOR_CREATED",entityType:"CONTRACTOR",entityId:t,userId:"2",userName:"Current User",userRole:e,description:"Контрагент создан: ".concat(R.name),metadata:{name:R.name,inn:R.inn,type:R.type}})),await I(),A(!1)}catch(e){console.error("Failed to save contractor:",e),alert("Не удалось сохранить контрагента")}finally{E(!1)}},Z=async a=>{try{let r=t.find(e=>e.id===a);await b.f.acceptOffer(a),r&&await j.W.logEvent({type:"CONTRACTOR_OFFER_ACCEPTED",entityType:"CONTRACTOR",entityId:a,userId:"2",userName:"Current User",userRole:e,description:"Оферта принята: ".concat(r.name),metadata:{name:r.name,inn:r.inn,type:r.type}}),await I()}catch(e){console.error("Failed to accept offer:",e),alert("Не удалось принять оферту")}},F=e=>(0,r.jsx)(o.C,{variant:"info",size:"sm",children:{DEVELOPER:"Застройщик",AGENCY:"АН",AGENT:"Агент",IP:"ИП",NPD:"НПД"}[e]});return(0,r.jsx)(s.A,{children:(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Контрагенты"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Управление контрагентами и статусами оферт"})]}),(0,r.jsxs)(l.z,{onClick:()=>{O(null),T({type:"AGENT",name:"",inn:"",kpp:"",accountNumber:"",bik:"",bankName:"",email:"",phone:""}),A(!0)},children:[(0,r.jsx)(m.Z,{className:"w-5 h-5 mr-2"}),"Добавить контрагента"]})]}),"M2_OPERATOR"===e&&(0,r.jsx)(N.N,{id:"m2-contractors-list",title:"\uD83D\uDC65 Управление исполнителями",description:"Здесь управляются все исполнители заявок застройщиков: агентства, агенты, ИП, НПД. Добавляйте новых исполнителей, проверяйте реквизиты, принимайте оферты. Каждый исполнитель должен принять оферту перед первой выплатой."}),"DEVELOPER_ADMIN"===e&&(0,r.jsx)(N.N,{id:"dev-contractors-list",title:"\uD83D\uDD0D Исполнители ваших заявок",description:"Здесь показаны все исполнители, которые работают с вашими заявками через М2. Вы видите агентства и агентов, которые находят клиентов из вашей базы контактов и оформляют сделки."}),"AGENCY_ADMIN"===e&&(0,r.jsx)(N.N,{id:"agency-contractors-list",title:"\uD83D\uDC68‍\uD83D\uDCBC Агенты вашего агентства",description:"Здесь управляются агенты вашего агентства. Добавляйте новых агентов, указывайте их реквизиты, следите за принятием оферт. Это нужно для корректного распределения комиссии между агентством и агентами."}),"CONTRACTOR"===e&&(0,r.jsx)(N.N,{id:"contractor-profile",title:"\uD83D\uDC64 Ваш профиль исполнителя",description:"Здесь ваши данные как исполнителя заявок. Убедитесь, что реквизиты указаны правильно - на них будут приходить выплаты. Обязательно примите оферту М2 перед началом работы."}),(0,r.jsx)(g.E,{...v.p.contractors}),(0,r.jsx)(i.Z,{padding:"none",children:d?(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)(h.Z,{className:"w-8 h-8 animate-spin mx-auto text-gray-400"}),(0,r.jsx)("p",{className:"text-gray-500 mt-4",children:"Загрузка контрагентов..."})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(p.iA,{children:[(0,r.jsx)(p.xD,{children:(0,r.jsxs)(p.SC,{children:[(0,r.jsx)(p.pj,{header:!0,children:"Тип"}),(0,r.jsx)(p.pj,{header:!0,children:"Название"}),(0,r.jsx)(p.pj,{header:!0,children:"ИНН / КПП"}),(0,r.jsx)(p.pj,{header:!0,children:"Реквизиты"}),(0,r.jsx)(p.pj,{header:!0,children:"Оферта"}),(0,r.jsx)(p.pj,{header:!0,children:"Дата создания"}),(0,r.jsx)(p.pj,{header:!0,children:" "})]})}),(0,r.jsx)(p.RM,{children:t.map(e=>(0,r.jsxs)(p.SC,{children:[(0,r.jsx)(p.pj,{children:F(e.type)}),(0,r.jsx)(p.pj,{children:(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium",children:e.name}),e.email&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:e.email})]})}),(0,r.jsx)(p.pj,{children:(0,r.jsxs)("div",{className:"font-mono text-xs",children:[(0,r.jsxs)("div",{children:["ИНН: ",e.inn]}),e.kpp&&(0,r.jsxs)("div",{children:["КПП: ",e.kpp]})]})}),(0,r.jsx)(p.pj,{children:(0,r.jsxs)("div",{className:"text-xs",children:[e.accountNumber&&(0,r.jsxs)("div",{children:["Р/С: ",e.accountNumber]}),e.bik&&(0,r.jsxs)("div",{children:["БИК: ",e.bik]}),e.bankName&&(0,r.jsx)("div",{className:"text-gray-500",children:e.bankName})]})}),(0,r.jsx)(p.pj,{children:e.offerAcceptedAt?(0,r.jsxs)("div",{className:"flex items-center gap-1 text-sm text-green-600",children:[(0,r.jsx)(x.Z,{className:"w-4 h-4"}),"Принята"]}):(0,r.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>Z(e.id),children:"Принять оферту"})}),(0,r.jsx)(p.pj,{className:"text-xs text-gray-500",children:(0,y.o0)(e.createdAt)}),(0,r.jsx)(p.pj,{children:(0,r.jsx)("div",{className:"flex gap-2",children:(0,r.jsx)(l.z,{variant:"ghost",size:"sm",onClick:()=>S(e),children:(0,r.jsx)(f.Z,{className:"w-4 h-4"})})})})]},e.id))})]}),0===t.length&&!d&&(0,r.jsx)("div",{className:"text-center py-12",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Пока нет контрагентов. Добавьте первого!"})})]})}),(0,r.jsx)(u,{isOpen:D,onClose:()=>A(!1),title:_?"Редактировать контрагента":"Новый контрагент",children:(0,r.jsxs)("form",{onSubmit:P,className:"space-y-4",children:[(0,r.jsx)(c.P,{label:"Тип контрагента",value:R.type,onChange:e=>T({...R,type:e.target.value}),options:[{value:"DEVELOPER",label:"Застройщик"},{value:"AGENCY",label:"Агентство недвижимости"},{value:"AGENT",label:"Агент (физлицо)"},{value:"IP",label:"Индивидуальный предприниматель"},{value:"NPD",label:"Самозанятый (НПД)"}],required:!0,disabled:w}),(0,r.jsx)(c.I,{label:"Название / ФИО",placeholder:"ООО Компания или Иванов Иван Иванович",value:R.name,onChange:e=>T({...R,name:e.target.value}),required:!0,disabled:w}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(c.I,{label:"ИНН",placeholder:"1234567890",value:R.inn,onChange:e=>T({...R,inn:e.target.value}),required:!0,disabled:w}),(0,r.jsx)(c.I,{label:"КПП",placeholder:"123456789",value:R.kpp,onChange:e=>T({...R,kpp:e.target.value}),disabled:w})]}),(0,r.jsx)(c.I,{label:"Расчётный счёт",placeholder:"40702810...",value:R.accountNumber,onChange:e=>T({...R,accountNumber:e.target.value}),disabled:w}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(c.I,{label:"БИК банка",placeholder:"044525225",value:R.bik,onChange:e=>T({...R,bik:e.target.value}),disabled:w}),(0,r.jsx)(c.I,{label:"Название банка",placeholder:"ПАО Сбербанк",value:R.bankName,onChange:e=>T({...R,bankName:e.target.value}),disabled:w})]}),(0,r.jsx)(c.I,{label:"Email",type:"email",placeholder:"email@example.com",value:R.email,onChange:e=>T({...R,email:e.target.value}),disabled:w}),(0,r.jsx)(c.I,{label:"Телефон",type:"tel",placeholder:"+7 (999) 123-45-67",value:R.phone,onChange:e=>T({...R,phone:e.target.value}),disabled:w}),(0,r.jsxs)("div",{className:"flex justify-end gap-3 pt-4",children:[(0,r.jsx)(l.z,{type:"button",variant:"secondary",onClick:()=>A(!1),disabled:w,children:"Отмена"}),(0,r.jsx)(l.z,{type:"submit",disabled:w,children:w?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(h.Z,{className:"w-4 h-4 mr-2 animate-spin"}),"Сохранение..."]}):_?"Сохранить":"Создать"})]})]})})]})})}},9379:function(e,t,a){"use strict";a.d(t,{C:function(){return s}});var r=a(7437);a(2265);var n=a(1994);let s=e=>{let{children:t,variant:a="default",size:s="md"}=e;return(0,r.jsx)("span",{className:(0,n.W)("inline-flex items-center rounded-full font-medium",{default:"bg-gray-100 text-gray-800",success:"bg-green-100 text-green-800",warning:"bg-yellow-100 text-yellow-800",danger:"bg-red-100 text-red-800",info:"bg-blue-100 text-blue-800"}[a],{sm:"px-2 py-0.5 text-xs",md:"px-2.5 py-1 text-sm"}[s]),children:t})}},8068:function(e,t,a){"use strict";a.d(t,{I:function(){return s},P:function(){return i}});var r=a(7437);a(2265);var n=a(1994);let s=e=>{let{label:t,error:a,helperText:s,className:i,...l}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,r.jsx)("input",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",i),...l}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a}),s&&!a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:s})]})},i=e=>{let{label:t,error:a,options:s,className:i,...l}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,r.jsx)("select",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",i),...l,children:s.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a})]})}},9057:function(e,t,a){"use strict";a.d(t,{f:function(){return i}});var r=a(2141),n=a(3694);class s{async getCounterparties(e){if(!(0,r.jv)()){console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)");let t=n.dp;return(null==e?void 0:e.type)&&(t=t.filter(t=>t.type===e.type)),(null==e?void 0:e.offerAccepted)!==void 0&&(t=t.filter(t=>e.offerAccepted?void 0!==t.offerAcceptedAt:void 0===t.offerAcceptedAt)),t}try{let t=r.OQ.from("counterparties").select("*").order("created_at",{ascending:!1});(null==e?void 0:e.type)&&(t=t.eq("type",e.type)),(null==e?void 0:e.offerAccepted)!==void 0&&(t=e.offerAccepted?t.not("offer_accepted_at","is",null):t.is("offer_accepted_at",null));let{data:a,error:n}=await t;if(n)throw n;return(a||[]).map(this.transformFromDB)}catch(e){throw console.error("Error fetching counterparties:",e),e}}async getCounterparty(e){if(!(0,r.jv)())return n.dp.find(t=>t.id===e)||null;try{let{data:t,error:a}=await r.OQ.from("counterparties").select("*").eq("id",e).single();if(a)throw a;if(!t)return null;return this.transformFromDB(t)}catch(e){return console.error("Error fetching counterparty:",e),null}}async createCounterparty(e){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:t,error:a}=await r.OQ.from("counterparties").insert({type:e.type,name:e.name,inn:e.inn,kpp:e.kpp,account_number:e.accountNumber,bik:e.bik,bank_name:e.bankName,email:e.email,phone:e.phone}).select().single();if(a)throw a;if(!t)throw Error("Failed to create counterparty");return this.transformFromDB(t)}catch(e){throw console.error("Error creating counterparty:",e),e}}async updateCounterparty(e,t){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:a,error:n}=await r.OQ.from("counterparties").update({type:t.type,name:t.name,inn:t.inn,kpp:t.kpp,account_number:t.accountNumber,bik:t.bik,bank_name:t.bankName,email:t.email,phone:t.phone}).eq("id",e).select().single();if(n)throw n;if(!a)throw Error("Counterparty not found");return this.transformFromDB(a)}catch(e){throw console.error("Error updating counterparty:",e),e}}async acceptOffer(e){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:t,error:a}=await r.OQ.from("counterparties").update({offer_accepted_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;if(!t)throw Error("Counterparty not found");return this.transformFromDB(t)}catch(e){throw console.error("Error accepting offer:",e),e}}transformFromDB(e){return{id:e.id,name:e.name,inn:e.inn,type:e.type,kpp:e.kpp,accountNumber:e.account_number,bik:e.bik,bankName:e.bank_name,email:e.email,phone:e.phone,offerAcceptedAt:e.offer_accepted_at?new Date(e.offer_accepted_at):void 0,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}let i=new s},1671:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},1817:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},9397:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},5868:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]])}},function(e){e.O(0,[211,545,769,652,875,971,117,744],function(){return e(e.s=6655)}),_N_E=e.O()}]);