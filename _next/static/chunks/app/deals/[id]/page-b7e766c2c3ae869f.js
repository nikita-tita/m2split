(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[453],{1666:function(e,t,a){Promise.resolve().then(a.bind(a,9147))},9147:function(e,t,a){"use strict";a.d(t,{default:function(){return v}});var r=a(7437),s=a(2265),n=a(824),c=a(9178),i=a(4226),d=a(9379),l=a(5930),o=a(1817),m=a(2660),u=a(1671),x=a(9277),h=a(5868),j=a(8930),p=a(9397),f=a(1384),y=a(7887),N=a(8509),g=a(2097),_=a(7648);function v(e){let{id:t}=e,[a,v]=(0,s.useState)(null),[b,D]=(0,s.useState)(!0),[w,A]=(0,s.useState)(!1),{currentRole:R,updateDeal:E}=(0,g.o)();(0,s.useEffect)(()=>{(async()=>{try{D(!0);let e=await y.P.getDeal(t);v(e)}catch(e){console.error("Failed to load deal:",e)}finally{D(!1)}})()},[t]);let S=async e=>{if(a){A(!0);try{try{await y.P.updateDeal({id:a.id,status:e})}catch(e){console.warn("Supabase not configured, updating store directly")}E(a.id,{status:e}),await N.W.logEvent({type:"DEAL_STATUS_CHANGED",entityType:"DEAL",entityId:a.id,userId:"2",userName:"Current User",userRole:R,description:"Статус сделки изменён: ".concat(a.status," → ").concat(e),metadata:{oldStatus:a.status,newStatus:e,dealNumber:a.dealNumber}});let t={...a,status:e,updatedAt:new Date};v(t),alert("Статус сделки изменён на ".concat(k(e)))}catch(e){console.error("Failed to update deal status:",e),alert("Не удалось изменить статус сделки")}finally{A(!1)}}},k=e=>({DRAFT:"Черновик",IN_PROGRESS:"В работе",IN_REGISTRY:"В реестре",APPROVED:"Утверждён",SENT_TO_BANK:"Отправлен в банк",PAID:"Выплачено",PARTIALLY_PAID:"Частично выплачено",CANCELLED:"Отменён"})[e]||e;if(b)return(0,r.jsx)(n.A,{children:(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)(o.Z,{className:"w-8 h-8 animate-spin mx-auto text-gray-400"}),(0,r.jsx)("p",{className:"text-gray-500 mt-4",children:"Загрузка сделки..."})]})});if(!a)return(0,r.jsx)(n.A,{children:(0,r.jsxs)("div",{className:"text-center py-12",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Сделка не найдена"}),(0,r.jsx)(_.default,{href:"/deals",children:(0,r.jsx)(i.z,{className:"mt-4",children:"Вернуться к списку"})})]})});let I=a.shares.reduce((e,t)=>e+t.sharePercent,0);return(0,r.jsx)(n.A,{children:(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)(_.default,{href:"/deals",children:(0,r.jsx)(i.z,{variant:"ghost",size:"sm",children:(0,r.jsx)(m.Z,{className:"w-5 h-5"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:a.objectName}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:a.objectAddress})]})]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(()=>{if(!a)return[];let e=[];switch(a.status){case"DRAFT":("M2_OPERATOR"===R||"DEVELOPER_ADMIN"===R)&&e.push({status:"IN_PROGRESS",label:"Подтвердить бронь",icon:"check"});break;case"IN_PROGRESS":"M2_OPERATOR"===R&&e.push({status:"IN_REGISTRY",label:"Добавить в реестр",icon:"check"});break;case"IN_REGISTRY":("M2_OPERATOR"===R||"DEVELOPER_ADMIN"===R)&&e.push({status:"PAID",label:"Отметить как выплачено",icon:"check"})}return e})().map(e=>(0,r.jsxs)(i.z,{variant:"primary",onClick:()=>S(e.status),disabled:w,children:[w?(0,r.jsx)(o.Z,{className:"w-5 h-5 mr-2 animate-spin"}):(0,r.jsx)(u.Z,{className:"w-5 h-5 mr-2"}),e.label]},e.status)),"IN_PROGRESS"===a.status&&"M2_OPERATOR"===R&&(0,r.jsxs)(i.z,{variant:"secondary",children:[(0,r.jsx)(x.Z,{className:"w-5 h-5 mr-2"}),"Сформировать реестр"]}),(0,r.jsxs)(i.z,{variant:"secondary",children:[(0,r.jsx)(h.Z,{className:"w-5 h-5 mr-2"}),"Редактировать"]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,r.jsxs)(c.Z,{className:"lg:col-span-2",children:[(0,r.jsx)(c.O,{title:"Информация о сделке"}),(0,r.jsxs)("dl",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"№ сделки"}),(0,r.jsx)("dd",{className:"mt-1 text-sm font-mono text-gray-900",children:a.dealNumber||a.id})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Лот"}),(0,r.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:a.lotNumber||"—"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Сумма КВН"}),(0,r.jsx)("dd",{className:"mt-1 text-sm font-semibold text-gray-900",children:(0,f.xG)(a.totalAmount)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Статус"}),(0,r.jsx)("dd",{className:"mt-1",children:(0,r.jsxs)(d.C,{variant:"IN_PROGRESS"===a.status?"info":"default",children:["DRAFT"===a.status&&"Черновик","IN_PROGRESS"===a.status&&"В работе","IN_REGISTRY"===a.status&&"В реестре","PAID"===a.status&&"Выплачено"]})})]}),a.contractNumber&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Договор №"}),(0,r.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:a.contractNumber})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Дата договора"}),(0,r.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:a.contractDate?(0,f.p6)(a.contractDate):"—"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Дата создания"}),(0,r.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:(0,f.p6)(a.createdAt)})]}),a.specialAccountReceiptDate&&(0,r.jsxs)("div",{children:[(0,r.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Поступило на спецсчёт"}),(0,r.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:(0,f.p6)(a.specialAccountReceiptDate)})]})]})]}),(0,r.jsxs)(c.Z,{children:[(0,r.jsx)(c.O,{title:"Валидация"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Сумма долей"}),(0,r.jsxs)(d.C,{variant:.01>Math.abs(I-100)?"success":"danger",children:[I.toFixed(2),"%"]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Участников"}),(0,r.jsx)("span",{className:"text-sm font-medium",children:a.shares.length})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Реквизиты"}),(0,r.jsx)(d.C,{variant:"success",children:"Заполнены"})]})]})]})]}),(0,r.jsxs)(c.Z,{padding:"none",children:[(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)(c.O,{title:"Распределение долей"})}),(0,r.jsxs)(l.iA,{children:[(0,r.jsx)(l.xD,{children:(0,r.jsxs)(l.SC,{children:[(0,r.jsx)(l.pj,{header:!0,children:"Получатель"}),(0,r.jsx)(l.pj,{header:!0,children:"Роль"}),(0,r.jsx)(l.pj,{header:!0,children:"Доля %"}),(0,r.jsx)(l.pj,{header:!0,children:"Сумма"}),(0,r.jsx)(l.pj,{header:!0,children:"Режим"}),(0,r.jsx)(l.pj,{header:!0,children:"Ставка НДС"}),(0,r.jsx)(l.pj,{header:!0,children:"Договор"}),(0,r.jsx)(l.pj,{header:!0,children:" "})]})}),(0,r.jsx)(l.RM,{children:a.shares.map(e=>{var t,a;return(0,r.jsxs)(l.SC,{children:[(0,r.jsx)(l.pj,{children:(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"font-medium",children:null===(t=e.contractor)||void 0===t?void 0:t.name}),(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["ИНН: ",null===(a=e.contractor)||void 0===a?void 0:a.inn]})]})}),(0,r.jsx)(l.pj,{children:(0,r.jsxs)(d.C,{size:"sm",variant:"info",children:["AGENCY"===e.role&&"АН","AGENT"===e.role&&"Агент","IP"===e.role&&"ИП","NPD"===e.role&&"НПД"]})}),(0,r.jsxs)(l.pj,{className:"font-medium",children:[e.sharePercent,"%"]}),(0,r.jsx)(l.pj,{className:"font-medium",children:(0,f.xG)(e.amount)}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(d.C,{size:"sm",children:(0,f.gG)(e.taxRegime)})}),(0,r.jsx)(l.pj,{children:e.vatRate?"".concat(e.vatRate,"%"):"—"}),(0,r.jsx)(l.pj,{children:(0,r.jsxs)("div",{className:"text-xs",children:[e.contractNumber&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{children:e.contractNumber}),e.contractDate&&(0,r.jsx)("div",{className:"text-gray-500",children:(0,f.p6)(e.contractDate)})]}),!e.contractNumber&&"—"]})}),(0,r.jsx)(l.pj,{children:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(i.z,{variant:"ghost",size:"sm",children:(0,r.jsx)(h.Z,{className:"w-4 h-4"})}),(0,r.jsx)(i.z,{variant:"ghost",size:"sm",children:(0,r.jsx)(j.Z,{className:"w-4 h-4 text-red-600"})})]})})]},e.id)})})]}),(0,r.jsx)("div",{className:"p-4 bg-gray-50 border-t",children:(0,r.jsxs)(i.z,{variant:"ghost",size:"sm",children:[(0,r.jsx)(p.Z,{className:"w-4 h-4 mr-2"}),"Добавить получателя"]})})]})]})})}},9379:function(e,t,a){"use strict";a.d(t,{C:function(){return n}});var r=a(7437);a(2265);var s=a(1994);let n=e=>{let{children:t,variant:a="default",size:n="md"}=e;return(0,r.jsx)("span",{className:(0,s.W)("inline-flex items-center rounded-full font-medium",{default:"bg-gray-100 text-gray-800",success:"bg-green-100 text-green-800",warning:"bg-yellow-100 text-yellow-800",danger:"bg-red-100 text-red-800",info:"bg-blue-100 text-blue-800"}[a],{sm:"px-2 py-0.5 text-xs",md:"px-2.5 py-1 text-sm"}[n]),children:t})}},7887:function(e,t,a){"use strict";a.d(t,{P:function(){return c}});var r=a(2141),s=a(3694);class n{async getDeals(e){if(!(0,r.jv)())return console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)"),s.G;try{let t=r.OQ.from("deals").select("\n          *,\n          developer:developer_id(id, name, inn),\n          agency:agency_id(id, name, inn),\n          deal_participants(\n            id,\n            role,\n            share_percent,\n            amount,\n            tax_regime,\n            vat_rate,\n            contract_number,\n            contract_date,\n            counterparty:counterparty_id(id, name, inn, type, account_number, bik, bank_name)\n          )\n        ").order("created_at",{ascending:!1});(null==e?void 0:e.status)&&(t=t.eq("status",e.status)),(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.agencyId)&&(t=t.eq("agency_id",e.agencyId));let{data:a,error:s}=await t;if(s)throw s;return(a||[]).map(this.transformDealFromDB)}catch(e){throw console.error("Error fetching deals:",e),e}}async getDeal(e){if(!(0,r.jv)())return s.G.find(t=>t.id===e)||null;try{let{data:t,error:a}=await r.OQ.from("deals").select("\n          *,\n          developer:developer_id(id, name, inn),\n          agency:agency_id(id, name, inn),\n          deal_participants(\n            id,\n            role,\n            share_percent,\n            amount,\n            tax_regime,\n            vat_rate,\n            contract_number,\n            contract_date,\n            counterparty:counterparty_id(id, name, inn, type, account_number, bik, bank_name)\n          )\n        ").eq("id",e).single();if(a)throw a;if(!t)return null;return this.transformDealFromDB(t)}catch(e){return console.error("Error fetching deal:",e),null}}async createDeal(e){if(!(0,r.jv)())throw Error("Supabase not configured. Please set up Supabase to create deals.");let t=e.shares.reduce((e,t)=>e+t.sharePercent,0);if(Math.abs(t-100)>.01)throw Error("Shares must sum to 100% (current: ".concat(t,"%)"));try{var a;let t="D-".concat(Date.now()),{data:s,error:n}=await r.OQ.from("deals").insert({deal_number:t,object_name:e.objectName,object_address:e.objectAddress,lot_number:e.lotNumber,developer_id:e.developerId,agency_id:e.agencyId,total_amount:e.totalAmount,commission_amount:e.commissionAmount,contract_number:e.contractNumber,contract_date:null===(a=e.contractDate)||void 0===a?void 0:a.toISOString().split("T")[0],status:"draft"}).select().single();if(n)throw n;if(!s)throw Error("Failed to create deal");let c=e.shares.map(e=>{var t;return{deal_id:s.id,counterparty_id:e.contractorId,role:e.role,share_percent:e.sharePercent,amount:e.amount,tax_regime:e.taxRegime,vat_rate:e.vatRate,contract_number:e.contractNumber,contract_date:null===(t=e.contractDate)||void 0===t?void 0:t.toISOString().split("T")[0]}}),{error:i}=await r.OQ.from("deal_participants").insert(c);if(i)throw i;let d=await this.getDeal(s.id);if(!d)throw Error("Failed to fetch created deal");return d}catch(e){throw console.error("Error creating deal:",e),e}}async updateDeal(e){if(!(0,r.jv)())throw Error("Supabase not configured");try{var t;let{data:a,error:s}=await r.OQ.from("deals").update({object_name:e.objectName,object_address:e.objectAddress,lot_number:e.lotNumber,total_amount:e.totalAmount,commission_amount:e.commissionAmount,contract_number:e.contractNumber,contract_date:null===(t=e.contractDate)||void 0===t?void 0:t.toISOString().split("T")[0],status:e.status}).eq("id",e.id).select().single();if(s)throw s;if(!a)throw Error("Deal not found");let n=await this.getDeal(e.id);if(!n)throw Error("Failed to fetch updated deal");return n}catch(e){throw console.error("Error updating deal:",e),e}}transformDealFromDB(e){return{id:e.id,dealNumber:e.deal_number||e.id,objectName:e.object_name,objectAddress:e.object_address,lotNumber:e.lot_number,totalAmount:parseFloat(e.total_amount||"0"),status:e.status,contractNumber:e.contract_number,contractDate:e.contract_date?new Date(e.contract_date):void 0,specialAccountReceiptDate:e.special_account_receipt_date?new Date(e.special_account_receipt_date):void 0,createdAt:new Date(e.created_at),shares:(e.deal_participants||[]).map(e=>({id:e.id,role:e.role,sharePercent:parseFloat(e.share_percent||"0"),amount:parseFloat(e.amount||"0"),taxRegime:e.tax_regime,vatRate:e.vat_rate?parseFloat(e.vat_rate):void 0,contractNumber:e.contract_number,contractDate:e.contract_date?new Date(e.contract_date):void 0,contractor:e.counterparty?{id:e.counterparty.id,name:e.counterparty.name,inn:e.counterparty.inn,type:e.counterparty.type,accountNumber:e.counterparty.account_number,bik:e.counterparty.bik,bankName:e.counterparty.bank_name,createdAt:new Date,updatedAt:new Date}:void 0}))}}}let c=new n},2660:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},1671:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},1817:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},9397:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},5868:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]])},8930:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])}},function(e){e.O(0,[211,545,769,875,971,117,744],function(){return e(e.s=1666)}),_N_E=e.O()}]);