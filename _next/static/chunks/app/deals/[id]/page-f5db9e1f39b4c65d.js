(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[453],{1666:function(e,t,s){Promise.resolve().then(s.bind(s,9147))},9147:function(e,t,s){"use strict";s.d(t,{default:function(){return R}});var a=s(7437),r=s(2265),i=s(824),n=s(9178),l=s(4226),c=s(9379),d=s(5930),m=s(1817),x=s(2660),h=s(1671),o=s(9277),u=s(5868),j=s(8930),p=s(9397),y=s(1384),N=s(7887),v=s(8509),f=s(2097),g=s(7648);function R(e){let{id:t}=e,[s,R]=(0,r.useState)(null),[E,_]=(0,r.useState)(!0),[I,A]=(0,r.useState)(!1),{currentRole:D,updateDeal:b}=(0,f.o)();(0,r.useEffect)(()=>{(async()=>{try{_(!0);let e=await N.P.getDeal(t);R(e)}catch(e){console.error("Failed to load deal:",e)}finally{_(!1)}})()},[t]);let w=async e=>{if(s){A(!0);try{try{await N.P.updateDeal({id:s.id,status:e})}catch(e){console.warn("Supabase not configured, updating store directly")}b(s.id,{status:e}),await v.W.logEvent({type:"DEAL_STATUS_CHANGED",entityType:"DEAL",entityId:s.id,userId:"2",userName:"Current User",userRole:D,description:"Статус сделки изменён: ".concat(s.status," → ").concat(e),metadata:{oldStatus:s.status,newStatus:e,dealNumber:s.dealNumber}});let t={...s,status:e,updatedAt:new Date};R(t),alert("Статус сделки изменён на ".concat(T(e)))}catch(e){console.error("Failed to update deal status:",e),alert("Не удалось изменить статус сделки")}finally{A(!1)}}},T=e=>({DRAFT:"Черновик",IN_PROGRESS:"В работе",IN_REGISTRY:"В реестре",APPROVED:"Утверждён",SENT_TO_BANK:"Отправлен в банк",PAID:"Выплачено",PARTIALLY_PAID:"Частично выплачено",CANCELLED:"Отменён"})[e]||e;if(E)return(0,a.jsx)(i.A,{children:(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)(m.Z,{className:"w-8 h-8 animate-spin mx-auto text-gray-400"}),(0,a.jsx)("p",{className:"text-gray-500 mt-4",children:"Загрузка сделки..."})]})});if(!s)return(0,a.jsx)(i.A,{children:(0,a.jsxs)("div",{className:"text-center py-12",children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Сделка не найдена"}),(0,a.jsx)(g.default,{href:"/deals",children:(0,a.jsx)(l.z,{className:"mt-4",children:"Вернуться к списку"})})]})});let P=s.shares.reduce((e,t)=>e+t.sharePercent,0);return(0,a.jsx)(i.A,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)(g.default,{href:"/deals",children:(0,a.jsx)(l.z,{variant:"ghost",size:"sm",children:(0,a.jsx)(x.Z,{className:"w-5 h-5"})})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:s.objectName}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:s.objectAddress})]})]}),(0,a.jsxs)("div",{className:"flex gap-3",children:[(()=>{if(!s)return[];let e=[];switch(s.status){case"DRAFT":("M2_OPERATOR"===D||"DEVELOPER_ADMIN"===D)&&e.push({status:"IN_PROGRESS",label:"Подтвердить бронь",icon:"check"});break;case"IN_PROGRESS":"M2_OPERATOR"===D&&e.push({status:"IN_REGISTRY",label:"Добавить в реестр",icon:"check"});break;case"IN_REGISTRY":("M2_OPERATOR"===D||"DEVELOPER_ADMIN"===D)&&e.push({status:"PAID",label:"Отметить как выплачено",icon:"check"})}return e})().map(e=>(0,a.jsxs)(l.z,{variant:"primary",onClick:()=>w(e.status),disabled:I,children:[I?(0,a.jsx)(m.Z,{className:"w-5 h-5 mr-2 animate-spin"}):(0,a.jsx)(h.Z,{className:"w-5 h-5 mr-2"}),e.label]},e.status)),"IN_PROGRESS"===s.status&&"M2_OPERATOR"===D&&(0,a.jsxs)(l.z,{variant:"secondary",children:[(0,a.jsx)(o.Z,{className:"w-5 h-5 mr-2"}),"Сформировать реестр"]}),(0,a.jsxs)(l.z,{variant:"secondary",children:[(0,a.jsx)(u.Z,{className:"w-5 h-5 mr-2"}),"Редактировать"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,a.jsxs)(n.Z,{className:"lg:col-span-2",children:[(0,a.jsx)(n.O,{title:"Информация о сделке"}),(0,a.jsxs)("dl",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"№ сделки"}),(0,a.jsx)("dd",{className:"mt-1 text-sm font-mono text-gray-900",children:s.dealNumber||s.id})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Лот"}),(0,a.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:s.lotNumber||"—"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Сумма КВН"}),(0,a.jsx)("dd",{className:"mt-1 text-sm font-semibold text-gray-900",children:(0,y.xG)(s.totalAmount)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Статус"}),(0,a.jsx)("dd",{className:"mt-1",children:(0,a.jsxs)(c.C,{variant:"IN_PROGRESS"===s.status?"info":"default",children:["DRAFT"===s.status&&"Черновик","IN_PROGRESS"===s.status&&"В работе","IN_REGISTRY"===s.status&&"В реестре","PAID"===s.status&&"Выплачено"]})})]}),s.contractNumber&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Договор №"}),(0,a.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:s.contractNumber})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Дата договора"}),(0,a.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:s.contractDate?(0,y.p6)(s.contractDate):"—"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Дата создания"}),(0,a.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:(0,y.p6)(s.createdAt)})]}),s.specialAccountReceiptDate&&(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-500",children:"Поступило на спецсчёт"}),(0,a.jsx)("dd",{className:"mt-1 text-sm text-gray-900",children:(0,y.p6)(s.specialAccountReceiptDate)})]})]})]}),(0,a.jsxs)(n.Z,{children:[(0,a.jsx)(n.O,{title:"Валидация"}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"Сумма долей"}),(0,a.jsxs)(c.C,{variant:.01>Math.abs(P-100)?"success":"danger",children:[P.toFixed(2),"%"]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"Участников"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:s.shares.length})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("span",{className:"text-sm text-gray-600",children:"Реквизиты"}),(0,a.jsx)(c.C,{variant:"success",children:"Заполнены"})]})]})]})]}),(0,a.jsxs)(n.Z,{padding:"none",children:[(0,a.jsx)("div",{className:"p-6",children:(0,a.jsx)(n.O,{title:"Распределение долей"})}),(0,a.jsxs)(d.iA,{children:[(0,a.jsx)(d.xD,{children:(0,a.jsxs)(d.SC,{children:[(0,a.jsx)(d.pj,{header:!0,children:"Получатель"}),(0,a.jsx)(d.pj,{header:!0,children:"Роль"}),(0,a.jsx)(d.pj,{header:!0,children:"Доля %"}),(0,a.jsx)(d.pj,{header:!0,children:"Сумма"}),(0,a.jsx)(d.pj,{header:!0,children:"Режим"}),(0,a.jsx)(d.pj,{header:!0,children:"Ставка НДС"}),(0,a.jsx)(d.pj,{header:!0,children:"Договор"}),(0,a.jsx)(d.pj,{header:!0,children:" "})]})}),(0,a.jsx)(d.RM,{children:s.shares.map(e=>{var t,s;return(0,a.jsxs)(d.SC,{children:[(0,a.jsx)(d.pj,{children:(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"font-medium",children:null===(t=e.contractor)||void 0===t?void 0:t.name}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["ИНН: ",null===(s=e.contractor)||void 0===s?void 0:s.inn]})]})}),(0,a.jsx)(d.pj,{children:(0,a.jsxs)(c.C,{size:"sm",variant:"info",children:["AGENCY"===e.role&&"АН","AGENT"===e.role&&"Агент","IP"===e.role&&"ИП","NPD"===e.role&&"НПД"]})}),(0,a.jsxs)(d.pj,{className:"font-medium",children:[e.sharePercent,"%"]}),(0,a.jsx)(d.pj,{className:"font-medium",children:(0,y.xG)(e.amount)}),(0,a.jsx)(d.pj,{children:(0,a.jsx)(c.C,{size:"sm",children:(0,y.gG)(e.taxRegime)})}),(0,a.jsx)(d.pj,{children:e.vatRate?"".concat(e.vatRate,"%"):"—"}),(0,a.jsx)(d.pj,{children:(0,a.jsxs)("div",{className:"text-xs",children:[e.contractNumber&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{children:e.contractNumber}),e.contractDate&&(0,a.jsx)("div",{className:"text-gray-500",children:(0,y.p6)(e.contractDate)})]}),!e.contractNumber&&"—"]})}),(0,a.jsx)(d.pj,{children:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(l.z,{variant:"ghost",size:"sm",children:(0,a.jsx)(u.Z,{className:"w-4 h-4"})}),(0,a.jsx)(l.z,{variant:"ghost",size:"sm",children:(0,a.jsx)(j.Z,{className:"w-4 h-4 text-red-600"})})]})})]},e.id)})})]}),(0,a.jsx)("div",{className:"p-4 bg-gray-50 border-t",children:(0,a.jsxs)(l.z,{variant:"ghost",size:"sm",children:[(0,a.jsx)(p.Z,{className:"w-4 h-4 mr-2"}),"Добавить получателя"]})})]})]})})}},8509:function(e,t,s){"use strict";s.d(t,{W:function(){return n}});var a=s(2141);let r=[];class i{async logEvent(e){let t={id:"evt".concat(Date.now()),type:e.type,entityType:e.entityType,entityId:e.entityId,userId:e.userId,userName:e.userName,userRole:e.userRole,description:e.description,metadata:e.metadata,timestamp:new Date};if(!(0,a.jv)())return r.push(t),console.log("\uD83D\uDCDD Event logged:",t),t;try{let{data:e,error:s}=await a.OQ.from("events").insert([{type:t.type,entity_type:t.entityType,entity_id:t.entityId,user_id:t.userId,user_name:t.userName,user_role:t.userRole,description:t.description,metadata:t.metadata,timestamp:t.timestamp}]).select().single();if(s)throw s;return{...t,id:e.id}}catch(e){return console.error("Failed to log event:",e),r.push(t),t}}async getEventsForEntity(e,t){if(!(0,a.jv)())return r.filter(s=>s.entityType===e&&s.entityId===t).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime());try{let{data:s,error:r}=await a.OQ.from("events").select("*").eq("entity_type",e).eq("entity_id",t).order("timestamp",{ascending:!1});if(r)throw r;return(s||[]).map(this.mapEvent)}catch(e){return console.error("Failed to fetch events:",e),[]}}async getAllEvents(e){if(!(0,a.jv)()){let t=[...r];return(null==e?void 0:e.entityType)&&(t=t.filter(t=>t.entityType===e.entityType)),(null==e?void 0:e.userId)&&(t=t.filter(t=>t.userId===e.userId)),(null==e?void 0:e.type)&&(t=t.filter(t=>t.type===e.type)),t.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()),(null==e?void 0:e.limit)&&(t=t.slice(0,e.limit)),t}try{let t=a.OQ.from("events").select("*").order("timestamp",{ascending:!1});(null==e?void 0:e.entityType)&&(t=t.eq("entity_type",e.entityType)),(null==e?void 0:e.userId)&&(t=t.eq("user_id",e.userId)),(null==e?void 0:e.type)&&(t=t.eq("type",e.type)),(null==e?void 0:e.limit)&&(t=t.limit(e.limit));let{data:s,error:r}=await t;if(r)throw r;return(s||[]).map(this.mapEvent)}catch(e){return console.error("Failed to fetch events:",e),[]}}clearEventLog(){r=[]}mapEvent(e){return{id:e.id,type:e.type,entityType:e.entity_type,entityId:e.entity_id,userId:e.user_id,userName:e.user_name,userRole:e.user_role,description:e.description,metadata:e.metadata,timestamp:new Date(e.timestamp)}}}let n=new i},2660:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},1671:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},5868:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]])},8930:function(e,t,s){"use strict";s.d(t,{Z:function(){return a}});let a=(0,s(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])}},function(e){e.O(0,[211,545,990,542,971,117,744],function(){return e(e.s=1666)}),_N_E=e.O()}]);