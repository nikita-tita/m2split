(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[657],{3422:function(e,t,a){Promise.resolve().then(a.bind(a,1368))},1368:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return S}});var s=a(7437),r=a(2265),n=a(824),l=a(9178),i=a(4226),o=a(8068),c=a(9379),d=a(5930),m=a(2660),u=a(3245),p=a(9397),v=a(8930),h=a(2097),j=a(3694),x=a(1384),g=a(9057),f=a(2141);let y=[{id:"prj-kvartal-domashniy",developerId:"dev-samolot",projectName:"ЖК \xabКвартал Домашний\xbb",region:"Москва",city:"Москва",address:"ул. Донецкая",isActive:!0,createdAt:new Date,updatedAt:new Date},{id:"prj-soyuz",developerId:"dev-rodina",projectName:"ЖК \xabСОЮЗ\xbb",region:"Москва",city:"Москва",address:"ул. Сельскохозяйственная",isActive:!0,createdAt:new Date,updatedAt:new Date}];class b{async getProjects(e){if(!(0,f.jv)())return console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)"),y;try{let t=f.OQ.from("projects").select("*").order("project_name",{ascending:!0});(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.city)&&(t=t.eq("city",e.city)),(null==e?void 0:e.isActive)!==void 0&&(t=t.eq("is_active",e.isActive));let{data:a,error:s}=await t;if(s)throw s;return(a||[]).map(this.transformFromDB)}catch(e){throw console.error("Error fetching projects:",e),e}}async getProject(e){if(!(0,f.jv)())return y.find(t=>t.id===e)||null;try{let{data:t,error:a}=await f.OQ.from("projects").select("*").eq("id",e).single();if(a)throw a;if(!t)return null;return this.transformFromDB(t)}catch(e){return console.error("Error fetching project:",e),null}}transformFromDB(e){return{id:e.id,developerId:e.developer_id,projectName:e.project_name,region:e.region,city:e.city,address:e.address,description:e.description,isActive:e.is_active,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}let N=new b,A=[{id:"tariff-1",tariffId:"TAR-SAMOLET-BASE",developerId:"dev-samolet",developerName:"Группа \xabСамолет\xbb",developerLegalEntity:"ООО \xabСамолет\xbb",projectId:"prj-kvartal-domashniy",projectName:"ЖК \xabКвартал Домашний\xbb",region:"Москва",city:"Москва",segment:"FLATS",objectCategory:"1_ROOM",paymentStage:"ADVANCE",commissionSchemeType:"PERCENT_OF_CONTRACT",commissionTotalPercent:2.7,promoFlag:"BASE",validFrom:new Date("2025-01-01"),validTo:new Date("2025-11-30"),isActive:!0,createdAt:new Date,updatedAt:new Date}];class I{async getTariffs(e){if(!(0,f.jv)())return console.log("Using mock tariffs"),A.filter(t=>(null==e||!e.developerId||t.developerId===e.developerId)&&(null==e||!e.projectId||t.projectId===e.projectId)&&(null==e||!e.segment||t.segment===e.segment)&&(null==e||!e.objectCategory||t.objectCategory===e.objectCategory)&&(null==e||!e.paymentStage||t.paymentStage===e.paymentStage)&&((null==e?void 0:e.isActive)===void 0||t.isActive===e.isActive));let t=f.OQ.from("tariffs").select("*").order("valid_from",{ascending:!1});(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.projectId)&&(t=t.eq("project_id",e.projectId)),(null==e?void 0:e.segment)&&(t=t.eq("segment",e.segment)),(null==e?void 0:e.objectCategory)&&(t=t.eq("object_category",e.objectCategory)),(null==e?void 0:e.paymentStage)&&(t=t.eq("payment_stage",e.paymentStage)),(null==e?void 0:e.isActive)!==void 0&&(t=t.eq("is_active",e.isActive));let{data:a,error:s}=await t;if(s)throw console.error("Error fetching tariffs:",s),s;return this.mapToTariffs(a||[])}async getTariff(e){if(!(0,f.jv)())return A.find(t=>t.id===e)||null;let{data:t,error:a}=await f.OQ.from("tariffs").select("*").eq("id",e).single();return a?(console.error("Error fetching tariff:",a),null):t?this.mapToTariff(t):null}async findBestTariff(e){let t={projectId:e.projectId,isActive:!0};e.developerId&&(t.developerId=e.developerId),e.segment&&(t.segment=e.segment),e.objectCategory&&(t.objectCategory=e.objectCategory);let a=await this.getTariffs(t);return 0===a.length?null:a.sort((e,t)=>{let a=e.commissionTotalPercent||0;return(t.commissionTotalPercent||0)-a})[0]}calculateCommission(e,t){if("PERCENT_OF_CONTRACT"===t.commissionSchemeType){let a=e*(t.commissionTotalPercent||0)/100;return t.commissionMinAmount&&a<t.commissionMinAmount&&(a=t.commissionMinAmount),t.commissionMaxAmount&&a>t.commissionMaxAmount&&(a=t.commissionMaxAmount),a}return"FIXED_AMOUNT"===t.commissionSchemeType&&t.commissionFixedAmount||0}getTariffDisplayInfo(e){return"PERCENT_OF_CONTRACT"===e.commissionSchemeType?"".concat(e.commissionTotalPercent,"% (максимальный тариф)"):"FIXED_AMOUNT"===e.commissionSchemeType?"".concat(e.commissionFixedAmount," ₽ (фикс.)"):"Ступенчатая шкала"}mapToTariff(e){return{id:e.id,tariffId:e.tariff_id,developerId:e.developer_id,developerName:e.developer_name,developerLegalEntity:e.developer_legal_entity,projectId:e.project_id,projectName:e.project_name,region:e.region,city:e.city,segment:e.segment,objectCategory:e.object_category,paymentStage:e.payment_stage,commissionSchemeType:e.commission_scheme_type,commissionTotalPercent:e.commission_total_percent,commissionFixedAmount:e.commission_fixed_amount,commissionMinAmount:e.commission_min_amount,commissionMaxAmount:e.commission_max_amount,promoFlag:e.promo_flag,promoDescription:e.promo_description,validFrom:new Date(e.valid_from),validTo:e.valid_to?new Date(e.valid_to):void 0,isActive:e.is_active,comments:e.comments,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}mapToTariffs(e){return e.map(e=>this.mapToTariff(e))}}let _=new I;var C=a(8509),T=a(3702),D=a(8332),w=a(7648),E=a(9376);function S(){let e=(0,E.useRouter)(),{addDeal:t,currentRole:a}=(0,h.o)(),f=["M2_OPERATOR","AGENCY_ADMIN"].includes(a),y="M2_OPERATOR"===a,b="AGENCY_ADMIN"===a,[A,I]=(0,r.useState)([]),[S,P]=(0,r.useState)([]),[R,O]=(0,r.useState)(""),[F,M]=(0,r.useState)(""),[k,q]=(0,r.useState)([]),[z,Z]=(0,r.useState)(""),[G,L]=(0,r.useState)(""),[U,B]=(0,r.useState)(""),[Q,V]=(0,r.useState)(""),[Y,H]=(0,r.useState)(""),[X,W]=(0,r.useState)(""),[J,K]=(0,r.useState)(""),[$,ee]=(0,r.useState)(""),[et,ea]=(0,r.useState)(""),[es,er]=(0,r.useState)(null),[en,el]=(0,r.useState)(0),[ei,eo]=(0,r.useState)([]);(0,r.useEffect)(()=>{f||e.push("/deals")},[f,e]),(0,r.useEffect)(()=>{y&&ec()},[y]),(0,r.useEffect)(()=>{R?q(S.filter(e=>e.developerId===R)):q([]),M(""),Z(""),L("")},[R,S]),(0,r.useEffect)(()=>{if(F){let e=S.find(e=>e.id===F);e&&(Z(e.projectName),L(e.address||"".concat(e.city,", ").concat(e.region)))}},[F,S]),(0,r.useEffect)(()=>{(async()=>{if(F&&R)try{let e=await _.findBestTariff({developerId:R,projectId:F});if(er(e),e&&Q){let t=_.calculateCommission(parseFloat(Q),e);el(t)}else el(0)}catch(e){console.error("Failed to find tariff:",e),er(null),el(0)}else er(null),el(0)})()},[F,R,Q]),(0,r.useEffect)(()=>{en>0&&ei.length>0&&eo(e=>e.map(e=>({...e,amount:en*e.sharePercent/100})))},[en]);let ec=async()=>{try{let e=await g.f.getCounterparties({type:"DEVELOPER",offerAccepted:!0});I(e);let t=await N.getProjects({city:"Москва",isActive:!0});P(t)}catch(e){console.error("Failed to load developers/projects:",e)}},ed=e=>{eo(ei.filter((t,a)=>a!==e))},em=(e,t,a)=>{let s=[...ei];s[e]={...s[e],[t]:a},"taxRegime"===t&&"OSN"===a?s[e].vatRate=20:"taxRegime"===t&&"OSN"!==a&&(s[e].vatRate=void 0),"sharePercent"===t&&en>0&&(s[e].amount=en*a/100),eo(s)},eu=ei.reduce((e,t)=>e+t.sharePercent,0),ep=.01>Math.abs(eu-100),ev=z&&G&&Q&&ei.length>0&&ep&&(b||y&&R&&F);return(0,s.jsx)(n.A,{children:(0,s.jsxs)("form",{onSubmit:s=>{if(s.preventDefault(),!ev)return;let r="d".concat(Date.now()),n=parseFloat(Q),l=ei.map((e,t)=>{let a=j.dp.find(t=>t.id===e.contractorId);return{id:"s".concat(r,"_").concat(t),contractorId:e.contractorId,contractor:a,role:e.role,sharePercent:e.sharePercent,amount:e.amount,taxRegime:e.taxRegime,vatRate:e.vatRate,contractNumber:e.contractNumber||void 0,contractDate:e.contractDate?new Date(e.contractDate):void 0}});t({id:r,objectName:z,objectAddress:G,lotNumber:U||void 0,developerId:R||void 0,projectId:F||void 0,totalAmount:n,status:"DRAFT",shares:l,contractNumber:Y||void 0,contractDate:X?new Date(X):void 0,clientName:J||void 0,clientPhone:$||void 0,clientEmail:et||void 0,tariffId:null==es?void 0:es.id,commissionCalculatedAmount:en||void 0,commissionActualAmount:en||void 0,responsibleUserId:"2",initiator:{role:"M2_OPERATOR",partyId:"1",userId:"2",timestamp:new Date},createdAt:new Date,updatedAt:new Date}),C.W.logEvent({type:"DEAL_CREATED",entityType:"DEAL",entityId:r,userId:"2",userName:"Current User",userRole:a,description:"Сделка создана: ".concat(z),metadata:{objectName:z,objectAddress:G,totalAmount:n,commissionAmount:en,participantsCount:ei.length,developerId:R,projectId:F}}),e.push("/deals/".concat(r))},className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)(w.default,{href:"/deals",children:(0,s.jsx)(i.z,{type:"button",variant:"ghost",size:"sm",children:(0,s.jsx)(m.Z,{className:"w-5 h-5"})})}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Создание сделки"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Укажите объект и распределите доли между участниками"}),y&&(0,s.jsxs)("div",{className:"mt-2 flex items-center gap-2 text-sm text-blue-600",children:[(0,s.jsx)(u.Z,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"Система работает только для объектов в Москве"})]})]})]}),(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)(w.default,{href:"/deals",children:(0,s.jsx)(i.z,{type:"button",variant:"secondary",children:"Отмена"})}),(0,s.jsx)(i.z,{type:"submit",disabled:!ev,children:"Создать сделку"})]})]}),(0,s.jsx)(T.E,{...D.p.dealCreation}),(0,s.jsxs)(l.Z,{children:[(0,s.jsx)(l.O,{title:"Основная информация"}),(0,s.jsxs)("div",{className:"space-y-4",children:[y&&(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsx)(o.P,{label:"Застройщик",value:R,onChange:e=>O(e.target.value),options:[{value:"",label:"Выберите застройщика"},...A.map(e=>({value:e.id,label:e.name}))],required:!0}),(0,s.jsx)(o.P,{label:"Проект / ЖК",value:F,onChange:e=>M(e.target.value),options:[{value:"",label:R?"Выберите проект":"Сначала выберите застройщика"},...k.map(e=>({value:e.id,label:e.projectName}))],required:!0,disabled:!R})]}),(0,s.jsx)(o.I,{label:"Название объекта",placeholder:"ЖК Солнечный",value:z,onChange:e=>Z(e.target.value),required:!0,disabled:y&&!F}),(0,s.jsx)(o.I,{label:"Адрес объекта",placeholder:"г. Москва, ул. Солнечная, д. 10",value:G,onChange:e=>L(e.target.value),required:!0,disabled:y&&!F}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsx)(o.I,{label:"Лот (квартира, офис)",placeholder:"Кв. 45",value:U,onChange:e=>B(e.target.value)}),(0,s.jsx)(o.I,{label:"Сумма договора с застройщиком (₽)",type:"number",placeholder:"15000000",value:Q,onChange:e=>V(e.target.value),required:!0})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsx)(o.I,{label:"Номер договора",placeholder:"ДК-2024-001",value:Y,onChange:e=>H(e.target.value)}),(0,s.jsx)(o.I,{label:"Дата договора",type:"date",value:X,onChange:e=>W(e.target.value)})]}),es&&Q&&(0,s.jsxs)("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,s.jsx)("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Расчет комиссии КВН"}),(0,s.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Тариф:"}),(0,s.jsx)("span",{className:"font-medium text-gray-900",children:_.getTariffDisplayInfo(es)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Сумма договора:"}),(0,s.jsx)("span",{className:"font-medium text-gray-900",children:(0,x.xG)(parseFloat(Q))})]}),(0,s.jsxs)("div",{className:"flex justify-between pt-2 border-t border-blue-200",children:[(0,s.jsx)("span",{className:"font-semibold text-blue-900",children:"Комиссия КВН:"}),(0,s.jsx)("span",{className:"font-bold text-blue-900",children:(0,x.xG)(en)})]}),(0,s.jsx)("p",{className:"text-xs text-blue-700 mt-2",children:"* Расчет на основе уникального клиента (максимальный тариф)"})]})]})]})]}),(0,s.jsxs)(l.Z,{children:[(0,s.jsx)(l.O,{title:"Информация о клиенте"}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"На кого бронируем объект"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(o.I,{label:"ФИО клиента",placeholder:"Иванов Иван Иванович",value:J,onChange:e=>K(e.target.value)}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsx)(o.I,{label:"Телефон",type:"tel",placeholder:"+7 (999) 123-45-67",value:$,onChange:e=>ee(e.target.value)}),(0,s.jsx)(o.I,{label:"Email",type:"email",placeholder:"client@example.com",value:et,onChange:e=>ea(e.target.value)})]})]})]}),(0,s.jsxs)(l.Z,{padding:"none",children:[(0,s.jsx)("div",{className:"p-6",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(l.O,{title:"Распределение долей"}),(0,s.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:["Сумма долей: ",eu.toFixed(2),"%"," ",ep?(0,s.jsx)(c.C,{variant:"success",size:"sm",children:"✓ Корректно"}):(0,s.jsx)(c.C,{variant:"danger",size:"sm",children:"Должно быть 100%"})]})]}),(0,s.jsxs)(i.z,{type:"button",variant:"secondary",size:"sm",onClick:()=>{eo([...ei,{contractorId:"",role:"AGENT",sharePercent:0,amount:0,taxRegime:"USN",contractNumber:"",contractDate:""}])},children:[(0,s.jsx)(p.Z,{className:"w-4 h-4 mr-2"}),"Добавить получателя"]})]})}),ei.length>0&&(0,s.jsxs)(d.iA,{children:[(0,s.jsx)(d.xD,{children:(0,s.jsxs)(d.SC,{children:[(0,s.jsx)(d.pj,{header:!0,children:"Контрагент"}),(0,s.jsx)(d.pj,{header:!0,children:"Роль"}),(0,s.jsx)(d.pj,{header:!0,children:"Доля %"}),(0,s.jsx)(d.pj,{header:!0,children:"Сумма"}),(0,s.jsx)(d.pj,{header:!0,children:"Режим"}),(0,s.jsx)(d.pj,{header:!0,children:"НДС %"}),(0,s.jsx)(d.pj,{header:!0,children:"Договор"}),(0,s.jsx)(d.pj,{header:!0,children:" "})]})}),(0,s.jsx)(d.RM,{children:ei.map((e,t)=>{var a;return(0,s.jsxs)(d.SC,{children:[(0,s.jsx)(d.pj,{children:(0,s.jsx)(o.P,{value:e.contractorId,onChange:e=>em(t,"contractorId",e.target.value),options:[{value:"",label:"Выберите контрагента"},...j.dp.map(e=>({value:e.id,label:"".concat(e.name," (").concat(e.inn,")")}))]})}),(0,s.jsx)(d.pj,{children:(0,s.jsx)(o.P,{value:e.role,onChange:e=>em(t,"role",e.target.value),options:[{value:"AGENCY",label:"АН"},{value:"AGENT",label:"Агент"},{value:"IP",label:"ИП"},{value:"NPD",label:"НПД"}]})}),(0,s.jsx)(d.pj,{children:(0,s.jsx)(o.I,{type:"number",step:"0.01",min:"0",max:"100",value:e.sharePercent||"",onChange:e=>em(t,"sharePercent",parseFloat(e.target.value)||0)})}),(0,s.jsx)(d.pj,{className:"font-medium",children:en>0&&e.amount>0?(0,x.xG)(e.amount):"—"}),(0,s.jsx)(d.pj,{children:(0,s.jsx)(o.P,{value:e.taxRegime,onChange:e=>em(t,"taxRegime",e.target.value),options:[{value:"OSN",label:"НДС"},{value:"USN",label:"УСН"},{value:"NPD",label:"НПД"}]})}),(0,s.jsx)(d.pj,{children:"OSN"===e.taxRegime?(0,s.jsx)(o.P,{value:(null===(a=e.vatRate)||void 0===a?void 0:a.toString())||"20",onChange:e=>em(t,"vatRate",parseInt(e.target.value)),options:[{value:"0",label:"0%"},{value:"10",label:"10%"},{value:"20",label:"20%"}]}):"—"}),(0,s.jsx)(d.pj,{children:(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)(o.I,{placeholder:"№ договора",value:e.contractNumber,onChange:e=>em(t,"contractNumber",e.target.value)}),(0,s.jsx)(o.I,{type:"date",value:e.contractDate,onChange:e=>em(t,"contractDate",e.target.value)})]})}),(0,s.jsx)(d.pj,{children:(0,s.jsx)(i.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>ed(t),children:(0,s.jsx)(v.Z,{className:"w-4 h-4 text-red-600"})})})]},t)})})]}),0===ei.length&&(0,s.jsx)("div",{className:"text-center py-12 border-t",children:(0,s.jsx)("p",{className:"text-gray-500",children:"Нажмите “Добавить получателя” для распределения долей"})})]})]})})}},2660:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});let s=(0,a(9205).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},8930:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});let s=(0,a(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])}},function(e){e.O(0,[211,545,990,514,751,971,117,744],function(){return e(e.s=3422)}),_N_E=e.O()}]);