(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[657],{3422:function(e,t,a){Promise.resolve().then(a.bind(a,1368))},1368:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return k}});var r=a(7437),n=a(2265),o=a(824),d=a(9178),s=a(4226),i=a(8068),l=a(9379),c=a(5930),p=a(2660),m=a(3245),u=a(9397),v=a(8930),j=a(2097),f=a(3694),g=a(1384),h=a(9057),y=a(2141);function A(e){let t=[],a=["А","Б","В","1","2","3"],r=(e=>{let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return Math.abs(t)})(e.id+e.projectName),n=25e4+r%1e5,o=(e,t,a)=>e+a%1e3/1e3*(t-e),d=0;return[{type:"STUDIO",count:1,areaMin:28,areaMax:35,label:"Студия"},{type:"1_ROOM",count:2,areaMin:38,areaMax:52,label:"1-комнатная"},{type:"2_ROOM",count:2,areaMin:55,areaMax:75,label:"2-комнатная"},{type:"3_ROOM",count:2,areaMin:80,areaMax:100,label:"3-комнатная"}].forEach(s=>{let{type:i,count:l,areaMin:c,areaMax:p,label:m}=s;for(let s=0;s<l;s++){let s=r+137*d,l=Math.round(10*o(c,p,s))/10,m=1e5*Math.round(l*n/1e5),u=Math.floor(o(3,18,s+1)),v=a[s%a.length],j="".concat(String(u).padStart(2,"0"),"-").concat(String(100+d).slice(-3));t.push({id:"apt-".concat(e.id,"-").concat(d),projectId:e.id,lotNumber:j,roomType:i,area:l,floor:u,section:v,price:m,status:"AVAILABLE",address:"".concat(e.projectName,", ").concat(e.address,", корп. ").concat(v,", кв. ").concat(j)}),d++}}),t}let x=[{id:"prj-kvartal-domashniy",developerId:"dev-samolot",projectName:"ЖК \xabКвартал Домашний\xbb",region:"Москва",city:"Москва",address:"ул. Донецкая",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-troparevo",developerId:"dev-samolot",projectName:"\xabТропарево Парк\xbb",region:"Москва",city:"Москва",address:"Новомосковский округ, Коммунарка",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-ostafevo",developerId:"dev-samolot",projectName:"ЖК \xabОстафьево\xbb",region:"Москва",city:"Москва",address:"пос. Рязановское, Остафьево",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-vnukovo",developerId:"dev-samolot",projectName:"ЖК \xabНовое Внуково\xbb",region:"Москва",city:"Москва",address:"Новомосковский округ, Внуково",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-alhimovo",developerId:"dev-samolot",projectName:"ЖК \xabАлхимово\xbb",region:"Москва",city:"Москва",address:"пос. Рязановское, Алхимово",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-kvartal-na-vode",developerId:"dev-samolot",projectName:"ЖК \xabКвартал на воде\xbb",region:"Москва",city:"Москва",address:"ул. Шоссейная",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-rumyantsevo",developerId:"dev-samolot",projectName:"ЖК \xabКвартал Румянцево\xbb",region:"Москва",city:"Москва",address:"Новомосковский округ, Коммунарка",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-olhovy",developerId:"dev-samolot",projectName:"ЖК \xabОльховый Квартал\xbb",region:"Москва",city:"Москва",address:"Новомосковский округ, пос. Газопровод",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-soyuz",developerId:"dev-rodina",projectName:"ЖК \xabСОЮЗ\xbb",region:"Москва",city:"Москва",address:"ул. Сельскохозяйственная",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-peredelkino",developerId:"dev-rodina",projectName:"ЖК \xabРодина Переделкино\xbb",region:"Москва",city:"Москва",address:"Боровское ш.",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-novye-smysly",developerId:"dev-unikey",projectName:"ЖК \xabНовые Смыслы\xbb",region:"Москва",city:"Москва",address:"ул. Александры Монаховой",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-metronom",developerId:"dev-brusnika",projectName:"Квартал \xabМетроном\xbb",region:"Москва",city:"Москва",address:"ул. Тагильская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-mons",developerId:"dev-brusnika",projectName:"Квартал \xabМОНС\xbb",region:"Москва",city:"Москва",address:"Огородный проезд",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-dom-a",developerId:"dev-brusnika",projectName:"ЖК \xabДом А\xbb",region:"Москва",city:"Москва",address:"ул. Дубининская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-set",developerId:"dev-mr-group",projectName:"ЖК \xabSET\xbb",region:"Москва",city:"Москва",address:"ул. Верейская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-detali",developerId:"dev-plus",projectName:"ЖК \xabДетали\xbb",region:"Москва",city:"Москва",address:"пос. Филимонковское",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-monblan",developerId:"dev-gals",projectName:"ЖК \xabМонблан\xbb",region:"Москва",city:"Москва",address:"Шлюзовая наб.",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-rozhdestvevka",developerId:"dev-gals",projectName:"ЖК \xabРождественка 8\xbb",region:"Москва",city:"Москва",address:"ул. Кузнецкий Мост, 17",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-mirapolis",developerId:"dev-osnova",projectName:"ЖК \xabМИРАПОЛИС\xbb",region:"Москва",city:"Москва",address:"пр. Мира, 222",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-evopark",developerId:"dev-osnova",projectName:"ЖК \xabEVOPARK Измайлово\xbb",region:"Москва",city:"Москва",address:"ул. Электродная, 2А",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-moments",developerId:"dev-forma",projectName:"ЖК \xabMoments\xbb",region:"Москва",city:"Москва",address:"Волоколамское ш.",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-soul",developerId:"dev-forma",projectName:"ЖК \xabSOUL\xbb",region:"Москва",city:"Москва",address:"ул. Часовая",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-amber",developerId:"dev-fsk",projectName:"ЖК \xabAMBER CITY\xbb",region:"Москва",city:"Москва",address:"ул. Розанова",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-sky",developerId:"dev-fsk",projectName:"ЖК \xabSky Garden\xbb",region:"Москва",city:"Москва",address:"Строительный проезд",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-rotterdam",developerId:"dev-fsk",projectName:"ЖК \xabRotterdam\xbb",region:"Москва",city:"Москва",address:"Варшавское ш.",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-sobytie",developerId:"dev-donstroy",projectName:"ЖК \xabСобытие\xbb",region:"Москва",city:"Москва",address:"ул. Лобачевского",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-luchi",developerId:"dev-lsr",projectName:"ЖК \xabЛУЧИ\xbb",region:"Москва",city:"Москва",address:"ул. Производственная",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-dmitrovskoe",developerId:"dev-lsr",projectName:"ЖК \xabДмитровское небо\xbb",region:"Москва",city:"Москва",address:"Ильменский проезд",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-salarevo",developerId:"dev-dsk",projectName:"\xab1-й Саларьевский\xbb",region:"Москва",city:"Москва",address:"пос. Московский",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-kavkaz",developerId:"dev-level",projectName:"ЖК \xabLevel Кавказский бульвар\xbb",region:"Москва",city:"Москва",address:"Кавказский бульвар",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-amur",developerId:"dev-level",projectName:"ЖК \xabLevel Амурская\xbb",region:"Москва",city:"Москва",address:"ул. Амурская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-pavel",developerId:"dev-level",projectName:"ЖК \xabLevel Павелецкая\xbb",region:"Москва",city:"Москва",address:"ул. Павелецкая",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-lefort",developerId:"dev-level",projectName:"ЖК \xabЛефорт\xbb",region:"Москва",city:"Москва",address:"ул. Лефортовская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-presn",developerId:"dev-level",projectName:"ЖК \xabLevel Пресненский\xbb",region:"Москва",city:"Москва",address:"Пресненская наб.",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-reka",developerId:"dev-level",projectName:"ЖК \xabРека\xbb",region:"Москва",city:"Москва",address:"наб. Тараса Шевченко",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-ambul",developerId:"dev-level",projectName:"ЖК \xabLevel Амбулаторный\xbb",region:"Москва",city:"Москва",address:"Амбулаторный проезд",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-rimskaya",developerId:"dev-level",projectName:"Дом \xabLevel Римская\xbb",region:"Москва",city:"Москва",address:"пл. Рогожская Застава",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-suharev",developerId:"dev-level",projectName:"ЖК \xabLevel Сухаревская\xbb",region:"Москва",city:"Москва",address:"ул. Сретенка",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-donskoj",developerId:"dev-level",projectName:"ЖК \xabLevel Донской\xbb",region:"Москва",city:"Москва",address:"ул. Донская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-sher",developerId:"dev-level",projectName:"ЖК \xabLevel Шереметьевская\xbb",region:"Москва",city:"Москва",address:"ул. Шереметьевская",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date},{id:"prj-level-lenin",developerId:"dev-level",projectName:"ЖК \xabLevel Ленинградский\xbb",region:"Москва",city:"Москва",address:"Ленинградский проспект",isActive:!0,apartments:[],createdAt:new Date,updatedAt:new Date}];x.forEach(e=>{e.apartments=A(e)});class w{async getProjects(e){if(!(0,y.jv)())return console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)"),x;try{let t=y.OQ.from("projects").select("*").order("project_name",{ascending:!0});(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.city)&&(t=t.eq("city",e.city)),(null==e?void 0:e.isActive)!==void 0&&(t=t.eq("is_active",e.isActive));let{data:a,error:r}=await t;if(r)throw r;let n=(a||[]).map(this.transformFromDB);return n.forEach(e=>{e.apartments=A(e)}),n}catch(e){throw console.error("Error fetching projects:",e),e}}async getProject(e){if(!(0,y.jv)())return x.find(t=>t.id===e)||null;try{let{data:t,error:a}=await y.OQ.from("projects").select("*").eq("id",e).single();if(a)throw a;if(!t)return null;let r=this.transformFromDB(t);return r.apartments=A(r),r}catch(e){return console.error("Error fetching project:",e),null}}transformFromDB(e){return{id:e.id,developerId:e.developer_id,projectName:e.project_name,region:e.region,city:e.city,address:e.address,description:e.description,isActive:e.is_active,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}let b=new w,D=[{id:"tariff-universal",tariffId:"TAR-UNIVERSAL-BASE",developerId:"",developerName:"Все застройщики",developerLegalEntity:"М2 (универсальный тариф)",projectId:"",projectName:"Все проекты",region:"Москва",city:"Москва",segment:"FLATS",objectCategory:"1_ROOM",paymentStage:"ADVANCE",commissionSchemeType:"PERCENT_OF_CONTRACT",commissionTotalPercent:2.5,promoFlag:"BASE",validFrom:new Date("2025-01-01"),validTo:new Date("2025-12-31"),isActive:!0,createdAt:new Date,updatedAt:new Date},{id:"tariff-samolot",tariffId:"TAR-SAMOLET-BASE",developerId:"dev-samolot",developerName:"Группа \xabСамолет\xbb",developerLegalEntity:"ООО \xabСамолет\xbb",projectId:"prj-kvartal-domashniy",projectName:"ЖК \xabКвартал Домашний\xbb",region:"Москва",city:"Москва",segment:"FLATS",objectCategory:"1_ROOM",paymentStage:"ADVANCE",commissionSchemeType:"PERCENT_OF_CONTRACT",commissionTotalPercent:2.7,promoFlag:"BASE",validFrom:new Date("2025-01-01"),validTo:new Date("2025-11-30"),isActive:!0,createdAt:new Date,updatedAt:new Date},{id:"tariff-level",tariffId:"TAR-LEVEL-BASE",developerId:"dev-level",developerName:"Level Group",developerLegalEntity:"ООО \xabLevel Group\xbb",projectId:"",projectName:"Все проекты Level Group",region:"Москва",city:"Москва",segment:"FLATS",objectCategory:"1_ROOM",paymentStage:"ADVANCE",commissionSchemeType:"PERCENT_OF_CONTRACT",commissionTotalPercent:3,promoFlag:"BASE",validFrom:new Date("2025-01-01"),validTo:new Date("2025-12-31"),isActive:!0,createdAt:new Date,updatedAt:new Date}];class N{async getTariffs(e){if(!(0,y.jv)())return console.log("Using mock tariffs"),D.filter(t=>(null==e||!e.developerId||!t.developerId||t.developerId===e.developerId)&&(null==e||!e.projectId||!t.projectId||t.projectId===e.projectId)&&(null==e||!e.segment||!t.segment||t.segment===e.segment)&&(null==e||!e.objectCategory||!t.objectCategory||t.objectCategory===e.objectCategory)&&(null==e||!e.paymentStage||!t.paymentStage||t.paymentStage===e.paymentStage)&&((null==e?void 0:e.isActive)===void 0||t.isActive===e.isActive));let t=y.OQ.from("tariffs").select("*").order("valid_from",{ascending:!1});(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.projectId)&&(t=t.eq("project_id",e.projectId)),(null==e?void 0:e.segment)&&(t=t.eq("segment",e.segment)),(null==e?void 0:e.objectCategory)&&(t=t.eq("object_category",e.objectCategory)),(null==e?void 0:e.paymentStage)&&(t=t.eq("payment_stage",e.paymentStage)),(null==e?void 0:e.isActive)!==void 0&&(t=t.eq("is_active",e.isActive));let{data:a,error:r}=await t;if(r)throw console.error("Error fetching tariffs:",r),r;return this.mapToTariffs(a||[])}async getTariff(e){if(!(0,y.jv)())return D.find(t=>t.id===e)||null;let{data:t,error:a}=await y.OQ.from("tariffs").select("*").eq("id",e).single();return a?(console.error("Error fetching tariff:",a),null):t?this.mapToTariff(t):null}async findBestTariff(e){let t={projectId:e.projectId,isActive:!0};e.developerId&&(t.developerId=e.developerId),e.segment&&(t.segment=e.segment),e.objectCategory&&(t.objectCategory=e.objectCategory);let a=await this.getTariffs(t);return 0===a.length?null:a.sort((e,t)=>{let a=e.commissionTotalPercent||0;return(t.commissionTotalPercent||0)-a})[0]}calculateCommission(e,t){if("PERCENT_OF_CONTRACT"===t.commissionSchemeType){let a=e*(t.commissionTotalPercent||0)/100;return t.commissionMinAmount&&a<t.commissionMinAmount&&(a=t.commissionMinAmount),t.commissionMaxAmount&&a>t.commissionMaxAmount&&(a=t.commissionMaxAmount),a}return"FIXED_AMOUNT"===t.commissionSchemeType&&t.commissionFixedAmount||0}getTariffDisplayInfo(e){return"PERCENT_OF_CONTRACT"===e.commissionSchemeType?"".concat(e.commissionTotalPercent,"% (максимальный тариф)"):"FIXED_AMOUNT"===e.commissionSchemeType?"".concat(e.commissionFixedAmount," ₽ (фикс.)"):"Ступенчатая шкала"}mapToTariff(e){return{id:e.id,tariffId:e.tariff_id,developerId:e.developer_id,developerName:e.developer_name,developerLegalEntity:e.developer_legal_entity,projectId:e.project_id,projectName:e.project_name,region:e.region,city:e.city,segment:e.segment,objectCategory:e.object_category,paymentStage:e.payment_stage,commissionSchemeType:e.commission_scheme_type,commissionTotalPercent:e.commission_total_percent,commissionFixedAmount:e.commission_fixed_amount,commissionMinAmount:e.commission_min_amount,commissionMaxAmount:e.commission_max_amount,promoFlag:e.promo_flag,promoDescription:e.promo_description,validFrom:new Date(e.valid_from),validTo:e.valid_to?new Date(e.valid_to):void 0,isActive:e.is_active,comments:e.comments,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}mapToTariffs(e){return e.map(e=>this.mapToTariff(e))}}let I=new N;var _=a(8509),T=a(3702),C=a(8332),E=a(9280),S=a(7648),O=a(9376);function k(){let e=(0,O.useRouter)(),{addDeal:t,currentRole:a}=(0,j.o)(),y=["M2_OPERATOR","AGENCY_ADMIN","CONTRACTOR"].includes(a),A="M2_OPERATOR"===a,x="AGENCY_ADMIN"===a,w="CONTRACTOR"===a,[D,N]=(0,n.useState)([]),[k,R]=(0,n.useState)([]),[M,P]=(0,n.useState)(""),[F,L]=(0,n.useState)(""),[q,B]=(0,n.useState)([]),[z,U]=(0,n.useState)(""),[Z,G]=(0,n.useState)([]),[V,Q]=(0,n.useState)(""),[W,Y]=(0,n.useState)(""),[H,X]=(0,n.useState)(""),[K,J]=(0,n.useState)(""),[$,ee]=(0,n.useState)(""),[et,ea]=(0,n.useState)(""),[er,en]=(0,n.useState)(""),[eo,ed]=(0,n.useState)(""),[es,ei]=(0,n.useState)(""),[el,ec]=(0,n.useState)(null),[ep,em]=(0,n.useState)(0),[eu,ev]=(0,n.useState)([]);(0,n.useEffect)(()=>{y||e.push("/deals")},[y,e]),(0,n.useEffect)(()=>{y&&ej()},[y]),(0,n.useEffect)(()=>{M?B(k.filter(e=>e.developerId===M)):B([]),L(""),U(""),G([]),Q(""),Y(""),X("")},[M,k]),(0,n.useEffect)(()=>{if(F){let e=k.find(e=>e.id===F);e&&e.apartments?G(e.apartments.filter(e=>"AVAILABLE"===e.status)):G([])}else G([]);U("")},[F,k]),(0,n.useEffect)(()=>{if(z&&Z.length>0){let e=Z.find(e=>e.id===z);e&&(X(e.lotNumber),Q("".concat("STUDIO"===e.roomType?"Студия":"1_ROOM"===e.roomType?"1-комнатная":"2_ROOM"===e.roomType?"2-комнатная":"3_ROOM"===e.roomType?"3-комнатная":"4-комнатная"," ").concat(e.area," м\xb2")),Y(e.address),J(e.price.toString()))}},[z,Z]),(0,n.useEffect)(()=>{(async()=>{if(F&&M)try{let e=await I.findBestTariff({developerId:M,projectId:F});if(ec(e),e&&K){let t=I.calculateCommission(parseFloat(K),e);em(t)}else em(0)}catch(e){console.error("Failed to find tariff:",e),ec(null),em(0)}else ec(null),em(0)})()},[F,M,K]),(0,n.useEffect)(()=>{ep>0&&eu.length>0&&ev(e=>e.map(e=>({...e,amount:ep*e.sharePercent/100})))},[ep]);let ej=async()=>{try{let e=await h.f.getCounterparties({type:"DEVELOPER",offerAccepted:!0});N(e);let t=await b.getProjects({city:"Москва",isActive:!0});R(t)}catch(e){console.error("Failed to load developers/projects:",e)}},ef=e=>{ev(eu.filter((t,a)=>a!==e))},eg=(e,t,a)=>{let r=[...eu];r[e]={...r[e],[t]:a},"taxRegime"===t&&"OSN"===a?r[e].vatRate=20:"taxRegime"===t&&"OSN"!==a&&(r[e].vatRate=void 0),"sharePercent"===t&&ep>0&&(r[e].amount=ep*a/100),ev(r)},eh=eu.reduce((e,t)=>e+t.sharePercent,0),ey=.01>Math.abs(eh-100),eA=V&&W&&K&&eu.length>0&&ey&&(x||A&&M&&F);return(0,r.jsx)(o.A,{children:(0,r.jsxs)("form",{onSubmit:r=>{if(r.preventDefault(),!eA)return;let n="d".concat(Date.now()),o=parseFloat(K),d=eu.map((e,t)=>{let a=f.dp.find(t=>t.id===e.contractorId);return{id:"s".concat(n,"_").concat(t),contractorId:e.contractorId,contractor:a,role:e.role,sharePercent:e.sharePercent,amount:e.amount,taxRegime:e.taxRegime,vatRate:e.vatRate,contractNumber:e.contractNumber||void 0,contractDate:e.contractDate?new Date(e.contractDate):void 0}});t({id:n,objectName:V,objectAddress:W,lotNumber:H||void 0,developerId:M||void 0,projectId:F||void 0,totalAmount:o,status:"DRAFT",shares:d,contractNumber:$||void 0,contractDate:et?new Date(et):void 0,clientName:er||void 0,clientPhone:eo||void 0,clientEmail:es||void 0,tariffId:null==el?void 0:el.id,commissionCalculatedAmount:ep||void 0,commissionActualAmount:ep||void 0,responsibleUserId:"2",initiator:{role:"M2_OPERATOR",partyId:"1",userId:"2",timestamp:new Date},createdAt:new Date,updatedAt:new Date}),_.W.logEvent({type:"DEAL_CREATED",entityType:"DEAL",entityId:n,userId:"2",userName:"Current User",userRole:a,description:"Сделка создана: ".concat(V),metadata:{objectName:V,objectAddress:W,totalAmount:o,commissionAmount:ep,participantsCount:eu.length,developerId:M,projectId:F}}),e.push("/deals/".concat(n))},className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)(S.default,{href:"/deals",children:(0,r.jsx)(s.z,{type:"button",variant:"ghost",size:"sm",children:(0,r.jsx)(p.Z,{className:"w-5 h-5"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Создание сделки"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Укажите объект и распределите доли между участниками"}),A&&(0,r.jsxs)("div",{className:"mt-2 flex items-center gap-2 text-sm text-blue-600",children:[(0,r.jsx)(m.Z,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"Система работает только для объектов в Москве"})]})]})]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)(S.default,{href:"/deals",children:(0,r.jsx)(s.z,{type:"button",variant:"secondary",children:"Отмена"})}),(0,r.jsx)(s.z,{type:"submit",disabled:!eA,children:"Создать сделку"})]})]}),w&&(0,r.jsx)(E.N,{id:"contractor-deal-form",title:"\uD83C\uDFE0 Выберите застройщика, ЖК и квартиру",description:"Сначала выберите застройщика, затем ЖК (проект), затем квартиру из списка доступных. Все данные (название, адрес, лот, цена) заполнятся автоматически! Система рассчитает комиссию КВН по тарифу М2 с застройщиком, и вы сможете распределить доли между участниками."}),(0,r.jsx)(T.E,{...C.p.dealCreation}),(0,r.jsxs)(d.Z,{children:[(0,r.jsx)(d.O,{title:"Основная информация"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(i.P,{label:"Застройщик",value:M,onChange:e=>P(e.target.value),options:[{value:"",label:"Выберите застройщика"},...D.map(e=>({value:e.id,label:e.name}))],required:!0}),(0,r.jsx)(i.P,{label:"Проект / ЖК",value:F,onChange:e=>L(e.target.value),options:[{value:"",label:M?"Выберите проект":"Сначала выберите застройщика"},...q.map(e=>({value:e.id,label:e.projectName}))],required:!0,disabled:!M})]}),F&&Z.length>0&&(0,r.jsx)(i.P,{label:"Квартира",value:z,onChange:e=>U(e.target.value),options:[{value:"",label:"Выберите квартиру"},...Z.map(e=>({value:e.id,label:"".concat(e.lotNumber," — ").concat("STUDIO"===e.roomType?"Студия":"1_ROOM"===e.roomType?"1к":"2_ROOM"===e.roomType?"2к":"3_ROOM"===e.roomType?"3к":"4к",", ").concat(e.area," м\xb2, ").concat(e.floor," этаж — ").concat((e.price/1e6).toFixed(1)," млн ₽")}))],required:!0}),(0,r.jsx)(i.I,{label:"Название объекта",placeholder:"ЖК Солнечный",value:V,onChange:e=>Q(e.target.value),required:!0,disabled:!F,helperText:z?"Заполнено автоматически на основе выбранной квартиры":""}),(0,r.jsx)(i.I,{label:"Адрес объекта",placeholder:"г. Москва, ул. Солнечная, д. 10",value:W,onChange:e=>Y(e.target.value),required:!0,disabled:!F,helperText:z?"Заполнено автоматически":""}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(i.I,{label:"Лот (квартира, офис)",placeholder:"Кв. 45",value:H,onChange:e=>X(e.target.value),disabled:!!z,helperText:z?"Заполнено автоматически":""}),(0,r.jsx)(i.I,{label:"Сумма договора с застройщиком (₽)",type:"number",placeholder:"15000000",value:K,onChange:e=>J(e.target.value),required:!0,disabled:!!z,helperText:z?"Заполнено автоматически (цена квартиры)":""})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(i.I,{label:"Номер договора",placeholder:"ДК-2024-001",value:$,onChange:e=>ee(e.target.value)}),(0,r.jsx)(i.I,{label:"Дата договора",type:"date",value:et,onChange:e=>ea(e.target.value)})]}),el&&K&&(0,r.jsxs)("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[(0,r.jsx)("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Расчет комиссии КВН"}),(0,r.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Тариф:"}),(0,r.jsx)("span",{className:"font-medium text-gray-900",children:I.getTariffDisplayInfo(el)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Сумма договора:"}),(0,r.jsx)("span",{className:"font-medium text-gray-900",children:(0,g.xG)(parseFloat(K))})]}),(0,r.jsxs)("div",{className:"flex justify-between pt-2 border-t border-blue-200",children:[(0,r.jsx)("span",{className:"font-semibold text-blue-900",children:"Комиссия КВН:"}),(0,r.jsx)("span",{className:"font-bold text-blue-900",children:(0,g.xG)(ep)})]}),(0,r.jsx)("p",{className:"text-xs text-blue-700 mt-2",children:"* Расчет на основе уникального клиента (максимальный тариф)"})]})]})]})]}),(0,r.jsxs)(d.Z,{children:[(0,r.jsx)(d.O,{title:"Информация о клиенте"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mb-4",children:"На кого бронируем объект"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)(i.I,{label:"ФИО клиента",placeholder:"Иванов Иван Иванович",value:er,onChange:e=>en(e.target.value)}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(i.I,{label:"Телефон",type:"tel",placeholder:"+7 (999) 123-45-67",value:eo,onChange:e=>ed(e.target.value)}),(0,r.jsx)(i.I,{label:"Email",type:"email",placeholder:"client@example.com",value:es,onChange:e=>ei(e.target.value)})]})]})]}),(0,r.jsxs)(d.Z,{padding:"none",children:[(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(d.O,{title:"Распределение долей"}),(0,r.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:["Сумма долей: ",eh.toFixed(2),"%"," ",ey?(0,r.jsx)(l.C,{variant:"success",size:"sm",children:"✓ Корректно"}):(0,r.jsx)(l.C,{variant:"danger",size:"sm",children:"Должно быть 100%"})]})]}),(0,r.jsxs)(s.z,{type:"button",variant:"secondary",size:"sm",onClick:()=>{ev([...eu,{contractorId:"",role:"AGENT",sharePercent:0,amount:0,taxRegime:"USN",contractNumber:"",contractDate:""}])},children:[(0,r.jsx)(u.Z,{className:"w-4 h-4 mr-2"}),"Добавить получателя"]})]})}),eu.length>0&&(0,r.jsxs)(c.iA,{children:[(0,r.jsx)(c.xD,{children:(0,r.jsxs)(c.SC,{children:[(0,r.jsx)(c.pj,{header:!0,children:"Контрагент"}),(0,r.jsx)(c.pj,{header:!0,children:"Роль"}),(0,r.jsx)(c.pj,{header:!0,children:"Доля %"}),(0,r.jsx)(c.pj,{header:!0,children:"Сумма"}),(0,r.jsx)(c.pj,{header:!0,children:"Режим"}),(0,r.jsx)(c.pj,{header:!0,children:"НДС %"}),(0,r.jsx)(c.pj,{header:!0,children:"Договор"}),(0,r.jsx)(c.pj,{header:!0,children:" "})]})}),(0,r.jsx)(c.RM,{children:eu.map((e,t)=>{var a;return(0,r.jsxs)(c.SC,{children:[(0,r.jsx)(c.pj,{children:(0,r.jsx)(i.P,{value:e.contractorId,onChange:e=>eg(t,"contractorId",e.target.value),options:[{value:"",label:"Выберите контрагента"},...f.dp.map(e=>({value:e.id,label:"".concat(e.name," (").concat(e.inn,")")}))]})}),(0,r.jsx)(c.pj,{children:(0,r.jsx)(i.P,{value:e.role,onChange:e=>eg(t,"role",e.target.value),options:[{value:"AGENCY",label:"АН"},{value:"AGENT",label:"Агент"},{value:"IP",label:"ИП"},{value:"NPD",label:"НПД"}]})}),(0,r.jsx)(c.pj,{children:(0,r.jsx)(i.I,{type:"number",step:"0.01",min:"0",max:"100",value:e.sharePercent||"",onChange:e=>eg(t,"sharePercent",parseFloat(e.target.value)||0)})}),(0,r.jsx)(c.pj,{className:"font-medium",children:ep>0&&e.amount>0?(0,g.xG)(e.amount):"—"}),(0,r.jsx)(c.pj,{children:(0,r.jsx)(i.P,{value:e.taxRegime,onChange:e=>eg(t,"taxRegime",e.target.value),options:[{value:"OSN",label:"НДС"},{value:"USN",label:"УСН"},{value:"NPD",label:"НПД"}]})}),(0,r.jsx)(c.pj,{children:"OSN"===e.taxRegime?(0,r.jsx)(i.P,{value:(null===(a=e.vatRate)||void 0===a?void 0:a.toString())||"20",onChange:e=>eg(t,"vatRate",parseInt(e.target.value)),options:[{value:"0",label:"0%"},{value:"10",label:"10%"},{value:"20",label:"20%"}]}):"—"}),(0,r.jsx)(c.pj,{children:(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(i.I,{placeholder:"№ договора",value:e.contractNumber,onChange:e=>eg(t,"contractNumber",e.target.value)}),(0,r.jsx)(i.I,{type:"date",value:e.contractDate,onChange:e=>eg(t,"contractDate",e.target.value)})]})}),(0,r.jsx)(c.pj,{children:(0,r.jsx)(s.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>ef(t),children:(0,r.jsx)(v.Z,{className:"w-4 h-4 text-red-600"})})})]},t)})})]}),0===eu.length&&(0,r.jsx)("div",{className:"text-center py-12 border-t",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Нажмите “Добавить получателя” для распределения долей"})})]})]})})}},9379:function(e,t,a){"use strict";a.d(t,{C:function(){return o}});var r=a(7437);a(2265);var n=a(1994);let o=e=>{let{children:t,variant:a="default",size:o="md"}=e;return(0,r.jsx)("span",{className:(0,n.W)("inline-flex items-center rounded-full font-medium",{default:"bg-gray-100 text-gray-800",success:"bg-green-100 text-green-800",warning:"bg-yellow-100 text-yellow-800",danger:"bg-red-100 text-red-800",info:"bg-blue-100 text-blue-800"}[a],{sm:"px-2 py-0.5 text-xs",md:"px-2.5 py-1 text-sm"}[o]),children:t})}},8068:function(e,t,a){"use strict";a.d(t,{I:function(){return o},P:function(){return d}});var r=a(7437);a(2265);var n=a(1994);let o=e=>{let{label:t,error:a,helperText:o,className:d,...s}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-900 mb-1",children:t}),(0,r.jsx)("input",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",d),...s}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a}),o&&!a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-600",children:o})]})},d=e=>{let{label:t,error:a,options:o,className:d,...s}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-900 mb-1",children:t}),(0,r.jsx)("select",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",d),...s,children:o.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a})]})}},9057:function(e,t,a){"use strict";a.d(t,{f:function(){return d}});var r=a(2141),n=a(3694);class o{async getCounterparties(e){if(!(0,r.jv)()){console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)");let t=n.dp;return(null==e?void 0:e.type)&&(t=t.filter(t=>t.type===e.type)),(null==e?void 0:e.offerAccepted)!==void 0&&(t=t.filter(t=>e.offerAccepted?void 0!==t.offerAcceptedAt:void 0===t.offerAcceptedAt)),t}try{let t=r.OQ.from("counterparties").select("*").order("created_at",{ascending:!1});(null==e?void 0:e.type)&&(t=t.eq("type",e.type)),(null==e?void 0:e.offerAccepted)!==void 0&&(t=e.offerAccepted?t.not("offer_accepted_at","is",null):t.is("offer_accepted_at",null));let{data:a,error:n}=await t;if(n)throw n;return(a||[]).map(this.transformFromDB)}catch(e){throw console.error("Error fetching counterparties:",e),e}}async getCounterparty(e){if(!(0,r.jv)())return n.dp.find(t=>t.id===e)||null;try{let{data:t,error:a}=await r.OQ.from("counterparties").select("*").eq("id",e).single();if(a)throw a;if(!t)return null;return this.transformFromDB(t)}catch(e){return console.error("Error fetching counterparty:",e),null}}async createCounterparty(e){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:t,error:a}=await r.OQ.from("counterparties").insert({type:e.type,name:e.name,inn:e.inn,kpp:e.kpp,account_number:e.accountNumber,bik:e.bik,bank_name:e.bankName,email:e.email,phone:e.phone}).select().single();if(a)throw a;if(!t)throw Error("Failed to create counterparty");return this.transformFromDB(t)}catch(e){throw console.error("Error creating counterparty:",e),e}}async updateCounterparty(e,t){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:a,error:n}=await r.OQ.from("counterparties").update({type:t.type,name:t.name,inn:t.inn,kpp:t.kpp,account_number:t.accountNumber,bik:t.bik,bank_name:t.bankName,email:t.email,phone:t.phone}).eq("id",e).select().single();if(n)throw n;if(!a)throw Error("Counterparty not found");return this.transformFromDB(a)}catch(e){throw console.error("Error updating counterparty:",e),e}}async acceptOffer(e){if(!(0,r.jv)())throw Error("Supabase not configured");try{let{data:t,error:a}=await r.OQ.from("counterparties").update({offer_accepted_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw a;if(!t)throw Error("Counterparty not found");return this.transformFromDB(t)}catch(e){throw console.error("Error accepting offer:",e),e}}transformFromDB(e){return{id:e.id,name:e.name,inn:e.inn,type:e.type,kpp:e.kpp,accountNumber:e.account_number,bik:e.bik,bankName:e.bank_name,email:e.email,phone:e.phone,offerAcceptedAt:e.offer_accepted_at?new Date(e.offer_accepted_at):void 0,createdAt:new Date(e.created_at),updatedAt:new Date(e.updated_at)}}}let d=new o},2660:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},9397:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},8930:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])}},function(e){e.O(0,[211,545,769,652,875,971,117,744],function(){return e(e.s=3422)}),_N_E=e.O()}]);