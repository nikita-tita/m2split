(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[772],{2976:function(e,t,a){Promise.resolve().then(a.bind(a,6473))},6473:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return y}});var n=a(7437),r=a(2265),c=a(824),o=a(9178),d=a(4226),s=a(8068),i=a(9379),l=a(5930),u=a(2735),m=a(9397),p=a(1817),D=a(1384),A=a(3375),f=a(7887),w=a(3702),h=a(8332),b=a(9280),x=a(2097),N=a(7648),v=a(9376);function y(){let e=(0,v.useRouter)(),{currentRole:t}=(0,x.o)(),[a,y]=(0,r.useState)([]),[j,g]=(0,r.useState)(!0),[E,_]=(0,r.useState)(""),[R,I]=(0,r.useState)("all");(0,r.useEffect)(()=>{k()},[]);let k=async()=>{try{g(!0);let e=await f.P.getDeals();y(e)}catch(e){console.error("Failed to load deals:",e)}finally{g(!1)}},P=a.filter(e=>{let t=e.objectName.toLowerCase().includes(E.toLowerCase())||e.objectAddress.toLowerCase().includes(E.toLowerCase())||e.lotNumber&&e.lotNumber.toLowerCase().includes(E.toLowerCase()),a="all"===R||e.status===R;return t&&a}),C=e=>(0,n.jsx)(i.C,{variant:{DRAFT:"default",IN_PROGRESS:"info",IN_REGISTRY:"warning",PAID:"success"}[e]||"default",children:{DRAFT:"Черновик",IN_PROGRESS:"В работе",IN_REGISTRY:"В реестре",PAID:"Выплачено",PARTIALLY_PAID:"Частично",CANCELLED:"Отменено"}[e]||e});return(0,n.jsx)(c.A,{children:(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Сделки"}),(0,n.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Управление сделками и распределением комиссий"})]}),(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsxs)(d.z,{variant:"secondary",onClick:()=>(0,A.Ww)(a),children:[(0,n.jsx)(u.Z,{className:"w-5 h-5 mr-2"}),"Экспорт"]}),(0,n.jsx)(N.default,{href:"/deals/new",children:(0,n.jsxs)(d.z,{children:[(0,n.jsx)(m.Z,{className:"w-5 h-5 mr-2"}),"Создать сделку"]})})]})]}),"CONTRACTOR"===t&&(0,n.jsx)(b.N,{id:"contractor-deals-list",title:"\uD83D\uDCCB Ваши сделки по заявкам застройщиков",description:"Здесь отображаются все сделки, которые вы создали, работая с базой контактов от застройщиков. Следите за статусами: Черновик → В работе → В реестре → Выплачено. Когда застройщик оплатит заявку, М2 автоматически распределит комиссию между всеми исполнителями."}),"AGENCY_ADMIN"===t&&(0,n.jsx)(b.N,{id:"agency-deals-list",title:"\uD83D\uDCCA Сделки вашего агентства",description:"Отслеживайте все сделки вашего агентства по заявкам застройщиков. Видите распределение долей между вашими агентами. М2 автоматически разделит комиссию между исполнителями после оплаты заявки застройщиком."}),"M2_OPERATOR"===t&&(0,n.jsx)(b.N,{id:"m2-deals-list",title:"\uD83C\uDFAF Управление заявками застройщиков",description:"Контролируйте все заявки застройщиков и их выполнение. Здесь видно, какие исполнители (агенты/АН) работают над каждой заявкой. Когда исполнителей несколько, система автоматически сплитит комиссию по их долям."}),(0,n.jsx)(w.E,{...h.p.dealsList}),(0,n.jsx)(o.Z,{children:(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,n.jsx)("div",{className:"md:col-span-2",children:(0,n.jsx)(s.I,{placeholder:"Поиск по объекту, адресу или лоту...",value:E,onChange:e=>_(e.target.value)})}),(0,n.jsx)(s.P,{value:R,onChange:e=>I(e.target.value),options:[{value:"all",label:"Все статусы"},{value:"DRAFT",label:"Черновик"},{value:"IN_PROGRESS",label:"В работе"},{value:"IN_REGISTRY",label:"В реестре"},{value:"PAID",label:"Выплачено"}]})]})}),(0,n.jsx)(o.Z,{padding:"none",children:j?(0,n.jsxs)("div",{className:"text-center py-12",children:[(0,n.jsx)(p.Z,{className:"w-8 h-8 animate-spin mx-auto text-gray-400"}),(0,n.jsx)("p",{className:"text-gray-500 mt-4",children:"Загрузка сделок..."})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(l.iA,{children:[(0,n.jsx)(l.xD,{children:(0,n.jsxs)(l.SC,{children:[(0,n.jsx)(l.pj,{header:!0,children:"№ сделки"}),(0,n.jsx)(l.pj,{header:!0,children:"Объект"}),(0,n.jsx)(l.pj,{header:!0,children:"Лот"}),(0,n.jsx)(l.pj,{header:!0,children:"Сумма КВН"}),(0,n.jsx)(l.pj,{header:!0,children:"Участников"}),(0,n.jsx)(l.pj,{header:!0,children:"Статус"}),(0,n.jsx)(l.pj,{header:!0,children:"Дата создания"}),(0,n.jsx)(l.pj,{header:!0,children:" "})]})}),(0,n.jsx)(l.RM,{children:P.map(t=>(0,n.jsxs)(l.SC,{onClick:()=>e.push("/deals/".concat(t.id)),className:"cursor-pointer hover:bg-gray-50 transition-colors",children:[(0,n.jsx)(l.pj,{children:(0,n.jsx)("span",{className:"font-mono text-xs",children:t.dealNumber||t.id})}),(0,n.jsx)(l.pj,{children:(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium",children:t.objectName}),(0,n.jsx)("div",{className:"text-xs text-gray-500 max-w-xs truncate",children:t.objectAddress})]})}),(0,n.jsx)(l.pj,{children:t.lotNumber||"—"}),(0,n.jsx)(l.pj,{className:"font-medium",children:(0,D.xG)(t.totalAmount)}),(0,n.jsx)(l.pj,{children:(0,n.jsx)("span",{className:"text-gray-600",children:t.shares.length})}),(0,n.jsx)(l.pj,{children:C(t.status)}),(0,n.jsx)(l.pj,{children:(0,D.p6)(t.createdAt)}),(0,n.jsx)(l.pj,{children:(0,n.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,n.jsx)(N.default,{href:"/deals/".concat(t.id),children:(0,n.jsx)(d.z,{variant:"ghost",size:"sm",children:"Открыть"})})})})]},t.id))})]}),0===P.length&&!j&&(0,n.jsx)("div",{className:"text-center py-12",children:(0,n.jsx)("p",{className:"text-gray-500",children:E||"all"!==R?"Сделки не найдены":"Пока нет сделок. Создайте первую сделку!"})})]})})]})})}},9379:function(e,t,a){"use strict";a.d(t,{C:function(){return c}});var n=a(7437);a(2265);var r=a(1994);let c=e=>{let{children:t,variant:a="default",size:c="md"}=e;return(0,n.jsx)("span",{className:(0,r.W)("inline-flex items-center rounded-full font-medium",{default:"bg-gray-100 text-gray-800",success:"bg-green-100 text-green-800",warning:"bg-yellow-100 text-yellow-800",danger:"bg-red-100 text-red-800",info:"bg-blue-100 text-blue-800"}[a],{sm:"px-2 py-0.5 text-xs",md:"px-2.5 py-1 text-sm"}[c]),children:t})}},8068:function(e,t,a){"use strict";a.d(t,{I:function(){return c},P:function(){return o}});var n=a(7437);a(2265);var r=a(1994);let c=e=>{let{label:t,error:a,helperText:c,className:o,...d}=e;return(0,n.jsxs)("div",{className:"w-full",children:[t&&(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,n.jsx)("input",{className:(0,r.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",o),...d}),a&&(0,n.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a}),c&&!a&&(0,n.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:c})]})},o=e=>{let{label:t,error:a,options:c,className:o,...d}=e;return(0,n.jsxs)("div",{className:"w-full",children:[t&&(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,n.jsx)("select",{className:(0,r.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",o),...d,children:c.map(e=>(0,n.jsx)("option",{value:e.value,children:e.label},e.value))}),a&&(0,n.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a})]})}},3375:function(e,t,a){"use strict";a.d(t,{Ww:function(){return s},ig:function(){return d}});var n=a(1384);let r=e=>["Получатель,ИНН,Счёт,БИК,Сумма,Режим налогообложения,Ставка НДС,Договор №,Дата договора,Комментарий",...e.lines.map(e=>{var t,a;return[(null===(t=e.contractor)||void 0===t?void 0:t.name)||"",e.inn,e.accountNumber,e.bik,e.amount.toFixed(2),e.taxRegime,(null===(a=e.vatRate)||void 0===a?void 0:a.toString())||"",e.contractNumber||"",e.contractDate?(0,n.p6)(e.contractDate):"",e.comment||""]}).map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),c=e=>["№ сделки,Объект,Адрес,Лот,Сумма КВН,Статус,Дата создания",...e.map(e=>[e.id,e.objectName,e.objectAddress,e.lotNumber||"",e.totalAmount.toFixed(2),e.status,(0,n.p6)(e.createdAt)]).map(e=>e.map(e=>'"'.concat(e,'"')).join(","))].join("\n"),o=(e,t,a)=>{let n=new Blob([e],{type:a}),r=URL.createObjectURL(n),c=document.createElement("a");c.href=r,c.download=t,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)},d=e=>{o(r(e),"registry_".concat(e.registryNumber,"_").concat((0,n.p6)(new Date),".csv"),"text/csv;charset=utf-8;")},s=e=>{o(c(e),"deals_".concat((0,n.p6)(new Date),".csv"),"text/csv;charset=utf-8;")}},3694:function(e,t,a){"use strict";a.d(t,{G:function(){return c},L$:function(){return s},bs:function(){return n},dp:function(){return r},kG:function(){return d},nh:function(){return o}});let n=[{id:"1",email:"admin@developer.ru",name:"Иван Застройщиков",role:"DEVELOPER_ADMIN",createdAt:new Date("2024-01-01")},{id:"2",email:"operator@m2split.ru",name:"Мария Операторова",role:"M2_OPERATOR",createdAt:new Date("2024-01-01")},{id:"3",email:"agency@realty.ru",name:'АН "Недвижимость+"',role:"CONTRACTOR",createdAt:new Date("2024-01-15")}],r=[{id:"dev-samolot",type:"DEVELOPER",name:"Группа \xabСамолет\xbb",inn:"7750005606",kpp:"775001001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-rodina",type:"DEVELOPER",name:"Группа \xabРодина\xbb",inn:"7728838886",kpp:"772801001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-unikey",type:"DEVELOPER",name:"Unikey",inn:"7750000001",kpp:"775000001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-brusnika",type:"DEVELOPER",name:"Брусника",inn:"6670394684",kpp:"667001001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-mr-group",type:"DEVELOPER",name:"MR Group",inn:"7710936098",kpp:"771001001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-plus",type:"DEVELOPER",name:"Plus Development",inn:"7750000002",kpp:"775000002",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-gals",type:"DEVELOPER",name:"Галс-Девелопмент",inn:"7743003457",kpp:"774301001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-osnova",type:"DEVELOPER",name:"ГК \xabОСНОВА\xbb",inn:"7750000003",kpp:"775000003",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-forma",type:"DEVELOPER",name:"Forma",inn:"7750000004",kpp:"775000004",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-fsk",type:"DEVELOPER",name:"ГК ФСК",inn:"7750000005",kpp:"775000005",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-donstroy",type:"DEVELOPER",name:"ДОНСТРОЙ",inn:"7728138022",kpp:"772801001",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-lsr",type:"DEVELOPER",name:"ЛСР. Недвижимость-Москва",inn:"7750000006",kpp:"775000006",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-dsk",type:"DEVELOPER",name:"ДСК-1",inn:"7750000007",kpp:"775000007",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-level",type:"DEVELOPER",name:"Level Group",inn:"7750000008",kpp:"775000008",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-capital",type:"DEVELOPER",name:"Capital Group",inn:"7750000009",kpp:"775000009",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"dev-mic",type:"DEVELOPER",name:"ГК \xabМИЦ\xbb",inn:"7750000010",kpp:"775000010",offerAcceptedAt:new Date("2024-01-01"),createdAt:new Date("2024-01-01"),updatedAt:new Date("2024-01-01")},{id:"c1",type:"AGENCY",name:'АН "Недвижимость Плюс"',inn:"7701234567",kpp:"770101001",accountNumber:"40702810100000001234",bik:"044525225",bankName:"ПАО Сбербанк",address:"г. Москва, ул. Примерная, д. 1",offerAcceptedAt:new Date("2024-02-01"),offerAcceptanceChannel:"email",createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-02-01")},{id:"c2",type:"AGENT",name:"Петров Петр Петрович",inn:"771234567890",accountNumber:"40817810200000002345",bik:"044525225",bankName:"ПАО Сбербанк",address:"г. Москва, ул. Агентская, д. 2",offerAcceptedAt:new Date("2024-02-05"),offerAcceptanceChannel:"web",createdAt:new Date("2024-01-20"),updatedAt:new Date("2024-02-05")},{id:"c3",type:"NPD",name:"Сидорова Анна Ивановна",inn:"123456789012",accountNumber:"40817810300000003456",bik:"044525974",bankName:"ПАО ВТБ",address:"г. Санкт-Петербург, пр. Невский, д. 100",offerAcceptedAt:new Date("2024-02-10"),offerAcceptanceChannel:"mobile",createdAt:new Date("2024-01-25"),updatedAt:new Date("2024-02-10")}],c=[{id:"d1",objectName:'ЖК "Солнечный"',objectAddress:"г. Москва, ул. Солнечная, д. 10, корп. 1",lotNumber:"Кв. 45",developerId:"1",totalAmount:15e6,status:"IN_PROGRESS",shares:[{id:"s1",contractorId:"c1",contractor:r[0],role:"AGENCY",sharePercent:60,amount:9e6,taxRegime:"OSN",vatRate:20,contractNumber:"АГ-001/2024",contractDate:new Date("2024-02-01")},{id:"s2",contractorId:"c2",contractor:r[1],role:"AGENT",sharePercent:30,amount:45e5,taxRegime:"USN",contractNumber:"АГ-002/2024",contractDate:new Date("2024-02-05")},{id:"s3",contractorId:"c3",contractor:r[2],role:"NPD",sharePercent:10,amount:15e5,taxRegime:"NPD",contractNumber:"АГ-003/2024",contractDate:new Date("2024-02-10")}],contractBasis:"Договор комиссии",contractNumber:"ДК-2024-001",contractDate:new Date("2024-02-01"),specialAccountReceiptDate:new Date("2024-02-15"),responsibleUserId:"2",initiator:{role:"M2_OPERATOR",partyId:"1",userId:"2",timestamp:new Date("2024-02-01")},createdAt:new Date("2024-02-01"),updatedAt:new Date("2024-02-15")},{id:"d2",objectName:'ЖК "Морской бриз"',objectAddress:"г. Санкт-Петербург, наб. Морская, д. 5",lotNumber:"Кв. 102",developerId:"1",totalAmount:22e6,status:"DRAFT",shares:[{id:"s4",contractorId:"c1",contractor:r[0],role:"AGENCY",sharePercent:70,amount:154e5,taxRegime:"OSN",vatRate:20},{id:"s5",contractorId:"c2",contractor:r[1],role:"AGENT",sharePercent:30,amount:66e5,taxRegime:"USN"}],responsibleUserId:"2",initiator:{role:"AGENCY_ADMIN",partyId:"c1",userId:"3",timestamp:new Date("2024-03-01")},createdAt:new Date("2024-03-01"),updatedAt:new Date("2024-03-01")}],o=[{id:"r1",registryNumber:"РЕЕ-2024-001",date:new Date("2024-03-15"),status:"APPROVED",totalAmount:15e6,linesCount:3,creatorId:"2",approverId:"1",approvedAt:new Date("2024-03-16"),lines:[{id:"l1",registryId:"r1",contractorId:"c1",contractor:r[0],role:"AGENCY",inn:"7701234567",accountNumber:"40702810100000001234",bik:"044525225",amount:9e6,taxRegime:"OSN",vatRate:20,contractNumber:"АГ-001/2024",contractDate:new Date("2024-02-01"),comment:"Комиссия за сделку ЖК Солнечный кв.45",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")},{id:"l2",registryId:"r1",contractorId:"c2",contractor:r[1],role:"AGENT",inn:"771234567890",accountNumber:"40817810200000002345",bik:"044525225",amount:45e5,taxRegime:"USN",contractNumber:"АГ-002/2024",contractDate:new Date("2024-02-05"),comment:"Агентское вознаграждение",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")},{id:"l3",registryId:"r1",contractorId:"c3",contractor:r[2],role:"NPD",inn:"123456789012",accountNumber:"40817810300000003456",bik:"044525974",amount:15e5,taxRegime:"NPD",contractNumber:"АГ-003/2024",contractDate:new Date("2024-02-10"),comment:"Услуги самозанятого",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")}],createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-16")}],d=[{id:"p1",registryId:"r1",lineId:"l1",contractorId:"c1",amount:9e6,status:"EXECUTED",bankReference:"BNK-2024-001",executedAt:new Date("2024-03-17"),createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-17")},{id:"p2",registryId:"r1",lineId:"l2",contractorId:"c2",amount:45e5,status:"ACCEPTED_BY_BANK",bankReference:"BNK-2024-002",createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-16")},{id:"p3",registryId:"r1",lineId:"l3",contractorId:"c3",amount:15e5,status:"ERROR",bankErrorCode:"ERR-01",bankErrorText:"Неверный номер счёта получателя",createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-16")}],s={specialAccountBalance:37e6,paidThisPeriod:9e6,pendingPayments:6e6,errorPayments:15e5,primaryDocCompletion:33.33,vatSavings:18e5}},7887:function(e,t,a){"use strict";a.d(t,{P:function(){return o}});var n=a(2141),r=a(3694);class c{async getDeals(e){if(!(0,n.jv)())return console.warn("\uD83D\uDCE6 Using mock data (Supabase not configured)"),r.G;try{let t=n.OQ.from("deals").select("\n          *,\n          developer:developer_id(id, name, inn),\n          agency:agency_id(id, name, inn),\n          deal_participants(\n            id,\n            role,\n            share_percent,\n            amount,\n            tax_regime,\n            vat_rate,\n            contract_number,\n            contract_date,\n            counterparty:counterparty_id(id, name, inn, type, account_number, bik, bank_name)\n          )\n        ").order("created_at",{ascending:!1});(null==e?void 0:e.status)&&(t=t.eq("status",e.status)),(null==e?void 0:e.developerId)&&(t=t.eq("developer_id",e.developerId)),(null==e?void 0:e.agencyId)&&(t=t.eq("agency_id",e.agencyId));let{data:a,error:r}=await t;if(r)throw r;return(a||[]).map(this.transformDealFromDB)}catch(e){throw console.error("Error fetching deals:",e),e}}async getDeal(e){if(!(0,n.jv)())return r.G.find(t=>t.id===e)||null;try{let{data:t,error:a}=await n.OQ.from("deals").select("\n          *,\n          developer:developer_id(id, name, inn),\n          agency:agency_id(id, name, inn),\n          deal_participants(\n            id,\n            role,\n            share_percent,\n            amount,\n            tax_regime,\n            vat_rate,\n            contract_number,\n            contract_date,\n            counterparty:counterparty_id(id, name, inn, type, account_number, bik, bank_name)\n          )\n        ").eq("id",e).single();if(a)throw a;if(!t)return null;return this.transformDealFromDB(t)}catch(e){return console.error("Error fetching deal:",e),null}}async createDeal(e){if(!(0,n.jv)())throw Error("Supabase not configured. Please set up Supabase to create deals.");let t=e.shares.reduce((e,t)=>e+t.sharePercent,0);if(Math.abs(t-100)>.01)throw Error("Shares must sum to 100% (current: ".concat(t,"%)"));try{var a;let t="D-".concat(Date.now()),{data:r,error:c}=await n.OQ.from("deals").insert({deal_number:t,object_name:e.objectName,object_address:e.objectAddress,lot_number:e.lotNumber,developer_id:e.developerId,agency_id:e.agencyId,total_amount:e.totalAmount,commission_amount:e.commissionAmount,contract_number:e.contractNumber,contract_date:null===(a=e.contractDate)||void 0===a?void 0:a.toISOString().split("T")[0],status:"draft"}).select().single();if(c)throw c;if(!r)throw Error("Failed to create deal");let o=e.shares.map(e=>{var t;return{deal_id:r.id,counterparty_id:e.contractorId,role:e.role,share_percent:e.sharePercent,amount:e.amount,tax_regime:e.taxRegime,vat_rate:e.vatRate,contract_number:e.contractNumber,contract_date:null===(t=e.contractDate)||void 0===t?void 0:t.toISOString().split("T")[0]}}),{error:d}=await n.OQ.from("deal_participants").insert(o);if(d)throw d;let s=await this.getDeal(r.id);if(!s)throw Error("Failed to fetch created deal");return s}catch(e){throw console.error("Error creating deal:",e),e}}async updateDeal(e){if(!(0,n.jv)())throw Error("Supabase not configured");try{var t;let{data:a,error:r}=await n.OQ.from("deals").update({object_name:e.objectName,object_address:e.objectAddress,lot_number:e.lotNumber,total_amount:e.totalAmount,commission_amount:e.commissionAmount,contract_number:e.contractNumber,contract_date:null===(t=e.contractDate)||void 0===t?void 0:t.toISOString().split("T")[0],status:e.status}).eq("id",e.id).select().single();if(r)throw r;if(!a)throw Error("Deal not found");let c=await this.getDeal(e.id);if(!c)throw Error("Failed to fetch updated deal");return c}catch(e){throw console.error("Error updating deal:",e),e}}transformDealFromDB(e){return{id:e.id,dealNumber:e.deal_number||e.id,objectName:e.object_name,objectAddress:e.object_address,lotNumber:e.lot_number,totalAmount:parseFloat(e.total_amount||"0"),status:e.status,contractNumber:e.contract_number,contractDate:e.contract_date?new Date(e.contract_date):void 0,specialAccountReceiptDate:e.special_account_receipt_date?new Date(e.special_account_receipt_date):void 0,createdAt:new Date(e.created_at),shares:(e.deal_participants||[]).map(e=>({id:e.id,role:e.role,sharePercent:parseFloat(e.share_percent||"0"),amount:parseFloat(e.amount||"0"),taxRegime:e.tax_regime,vatRate:e.vat_rate?parseFloat(e.vat_rate):void 0,contractNumber:e.contract_number,contractDate:e.contract_date?new Date(e.contract_date):void 0,contractor:e.counterparty?{id:e.counterparty.id,name:e.counterparty.name,inn:e.counterparty.inn,type:e.counterparty.type,accountNumber:e.counterparty.account_number,bik:e.counterparty.bik,bankName:e.counterparty.bank_name,createdAt:new Date,updatedAt:new Date}:void 0}))}}}let o=new c},2141:function(e,t,a){"use strict";a.d(t,{OQ:function(){return l},jv:function(){return d}});var n=a(1545),r=a(257);let c=r.env.NEXT_PUBLIC_SUPABASE_URL||"",o=r.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"",d=()=>!!(c&&o),s=null,i=()=>d()?(s||(s=(0,n.eI)(c,o)),s):(console.warn("⚠️ Supabase credentials not configured. Using mock data."),null),l=new Proxy({},{get(e,t){let a=i();if(!a)throw Error("Supabase not configured");return a[t]}})},2735:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])},1817:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},9397:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});let n=(0,a(9205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])}},function(e){e.O(0,[211,545,769,652,971,117,744],function(){return e(e.s=2976)}),_N_E=e.O()}]);