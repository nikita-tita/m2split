(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[495],{6593:function(e,t,a){Promise.resolve().then(a.bind(a,9755))},9755:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return b}});var r=a(7437),n=a(2265),c=a(824),i=a(9178),s=a(4226),o=a(8068),l=a(5930),d=a(2660),u=a(9397),m=a(8930),p=a(2097),x=a(3694),y=a(1384),h=a(8509),g=a(3702),v=a(8332),N=a(7648),f=a(9376);function b(){let e=(0,f.useRouter)(),{addRegistry:t}=(0,p.o)(),[a,b]=(0,n.useState)(new Date().toISOString().split("T")[0]),[j,D]=(0,n.useState)([]),w=e=>{D(j.filter((t,a)=>a!==e))},A=(e,t,a)=>{let r=[...j];r[e]={...r[e],[t]:a},"taxRegime"===t&&"OSN"===a?r[e].vatRate=20:"taxRegime"===t&&"OSN"!==a&&(r[e].vatRate=void 0),D(r)},I=j.reduce((e,t)=>e+(t.amount||0),0),R=a&&j.length>0&&j.every(e=>e.contractorId&&e.amount>0);return(0,r.jsx)(c.A,{children:(0,r.jsxs)("form",{onSubmit:r=>{if(r.preventDefault(),!R)return;let n="r".concat(Date.now()),c="РЕЕ-".concat(new Date().getFullYear(),"-").concat(String(Math.floor(1e3*Math.random())).padStart(3,"0")),i=j.map((e,t)=>{let a=x.dp.find(t=>t.id===e.contractorId);return{id:"l".concat(n,"_").concat(t),registryId:n,contractorId:e.contractorId,contractor:a,role:e.role,inn:(null==a?void 0:a.inn)||"",accountNumber:(null==a?void 0:a.accountNumber)||"",bik:(null==a?void 0:a.bik)||"",amount:e.amount,taxRegime:e.taxRegime,vatRate:e.vatRate,contractNumber:e.contractNumber||void 0,contractDate:e.contractDate?new Date(e.contractDate):void 0,comment:e.comment||void 0,paymentStatus:"PENDING",createdAt:new Date,updatedAt:new Date}});t({id:n,registryNumber:c,date:new Date(a),status:"DRAFT",totalAmount:I,linesCount:j.length,creatorId:"2",lines:i,createdAt:new Date,updatedAt:new Date}),h.W.logEvent({type:"REGISTRY_CREATED",entityType:"REGISTRY",entityId:n,userId:"2",userName:"M2 Operator",userRole:"M2_OPERATOR",description:"Реестр создан: ".concat(c),metadata:{registryNumber:c,totalAmount:I,linesCount:j.length,date:a}}),e.push("/registries/".concat(n))},className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsx)(N.default,{href:"/registries",children:(0,r.jsx)(s.z,{type:"button",variant:"ghost",size:"sm",children:(0,r.jsx)(d.Z,{className:"w-5 h-5"})})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Создание реестра"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Сформируйте реестр выплат для отправки в банк"})]})]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)(N.default,{href:"/registries",children:(0,r.jsx)(s.z,{type:"button",variant:"secondary",children:"Отмена"})}),(0,r.jsx)(s.z,{type:"submit",disabled:!R,children:"Создать реестр"})]})]}),(0,r.jsx)(g.E,{...v.p.registryCreation}),(0,r.jsxs)(i.Z,{children:[(0,r.jsx)(i.O,{title:"Основная информация"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(o.I,{label:"Дата реестра",type:"date",value:a,onChange:e=>b(e.target.value),required:!0}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Общая сумма"}),(0,r.jsx)("div",{className:"text-2xl font-bold text-gray-900",children:(0,y.xG)(I)})]})]})]}),(0,r.jsxs)(i.Z,{padding:"none",children:[(0,r.jsx)("div",{className:"p-6",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(i.O,{title:"Строки выплат"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"Добавьте получателей и суммы выплат"})]}),(0,r.jsxs)(s.z,{type:"button",variant:"secondary",size:"sm",onClick:()=>{D([...j,{contractorId:"",role:"AGENT",amount:0,taxRegime:"USN",contractNumber:"",contractDate:"",comment:""}])},children:[(0,r.jsx)(u.Z,{className:"w-4 h-4 mr-2"}),"Добавить строку"]})]})}),j.length>0&&(0,r.jsxs)(l.iA,{children:[(0,r.jsx)(l.xD,{children:(0,r.jsxs)(l.SC,{children:[(0,r.jsx)(l.pj,{header:!0,children:"Контрагент"}),(0,r.jsx)(l.pj,{header:!0,children:"Роль"}),(0,r.jsx)(l.pj,{header:!0,children:"Сумма (₽)"}),(0,r.jsx)(l.pj,{header:!0,children:"Режим"}),(0,r.jsx)(l.pj,{header:!0,children:"НДС %"}),(0,r.jsx)(l.pj,{header:!0,children:"Договор"}),(0,r.jsx)(l.pj,{header:!0,children:"Комментарий"}),(0,r.jsx)(l.pj,{header:!0,children:" "})]})}),(0,r.jsx)(l.RM,{children:j.map((e,t)=>{var a;return(0,r.jsxs)(l.SC,{children:[(0,r.jsx)(l.pj,{children:(0,r.jsx)(o.P,{value:e.contractorId,onChange:e=>A(t,"contractorId",e.target.value),options:[{value:"",label:"Выберите контрагента"},...x.dp.map(e=>({value:e.id,label:"".concat(e.name," (").concat(e.inn,")")}))]})}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(o.P,{value:e.role,onChange:e=>A(t,"role",e.target.value),options:[{value:"AGENCY",label:"АН"},{value:"AGENT",label:"Агент"},{value:"IP",label:"ИП"},{value:"NPD",label:"НПД"}]})}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(o.I,{type:"number",min:"0",step:"0.01",value:e.amount||"",onChange:e=>A(t,"amount",parseFloat(e.target.value)||0)})}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(o.P,{value:e.taxRegime,onChange:e=>A(t,"taxRegime",e.target.value),options:[{value:"OSN",label:"НДС"},{value:"USN",label:"УСН"},{value:"NPD",label:"НПД"}]})}),(0,r.jsx)(l.pj,{children:"OSN"===e.taxRegime?(0,r.jsx)(o.P,{value:(null===(a=e.vatRate)||void 0===a?void 0:a.toString())||"20",onChange:e=>A(t,"vatRate",parseInt(e.target.value)),options:[{value:"0",label:"0%"},{value:"10",label:"10%"},{value:"20",label:"20%"}]}):"—"}),(0,r.jsx)(l.pj,{children:(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.I,{placeholder:"№ договора",value:e.contractNumber,onChange:e=>A(t,"contractNumber",e.target.value)}),(0,r.jsx)(o.I,{type:"date",value:e.contractDate,onChange:e=>A(t,"contractDate",e.target.value)})]})}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(o.I,{placeholder:"Назначение платежа",value:e.comment,onChange:e=>A(t,"comment",e.target.value)})}),(0,r.jsx)(l.pj,{children:(0,r.jsx)(s.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>w(t),children:(0,r.jsx)(m.Z,{className:"w-4 h-4 text-red-600"})})})]},t)})})]}),0===j.length&&(0,r.jsx)("div",{className:"text-center py-12 border-t",children:(0,r.jsx)("p",{className:"text-gray-500",children:"Нажмите “Добавить строку” для создания выплат"})})]})]})})}},4226:function(e,t,a){"use strict";a.d(t,{z:function(){return c}});var r=a(7437);a(2265);var n=a(1994);let c=e=>{let{variant:t="primary",size:a="md",className:c,children:i,disabled:s,...o}=e;return(0,r.jsx)("button",{className:(0,n.W)("inline-flex items-center justify-center rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",{primary:"bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500",secondary:"bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500",danger:"bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",ghost:"bg-transparent text-gray-700 hover:bg-gray-100 focus:ring-gray-500"}[t],{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-base",lg:"px-6 py-3 text-lg"}[a],c),disabled:s,...o,children:i})}},8068:function(e,t,a){"use strict";a.d(t,{I:function(){return c},P:function(){return i}});var r=a(7437);a(2265);var n=a(1994);let c=e=>{let{label:t,error:a,helperText:c,className:i,...s}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,r.jsx)("input",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",i),...s}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a}),c&&!a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:c})]})},i=e=>{let{label:t,error:a,options:c,className:i,...s}=e;return(0,r.jsxs)("div",{className:"w-full",children:[t&&(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:t}),(0,r.jsx)("select",{className:(0,n.W)("w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",a?"border-red-300":"border-gray-300",i),...s,children:c.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))}),a&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600",children:a})]})}},3694:function(e,t,a){"use strict";a.d(t,{G:function(){return c},L$:function(){return o},bs:function(){return r},dp:function(){return n},kG:function(){return s},nh:function(){return i}});let r=[{id:"1",email:"admin@developer.ru",name:"Иван Застройщиков",role:"DEVELOPER_ADMIN",createdAt:new Date("2024-01-01")},{id:"2",email:"operator@m2split.ru",name:"Мария Операторова",role:"M2_OPERATOR",createdAt:new Date("2024-01-01")},{id:"3",email:"agency@realty.ru",name:'АН "Недвижимость+"',role:"CONTRACTOR",createdAt:new Date("2024-01-15")}],n=[{id:"c1",type:"AGENCY",name:'АН "Недвижимость Плюс"',inn:"7701234567",kpp:"770101001",accountNumber:"40702810100000001234",bik:"044525225",bankName:"ПАО Сбербанк",address:"г. Москва, ул. Примерная, д. 1",offerAcceptedAt:new Date("2024-02-01"),offerAcceptanceChannel:"email",createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-02-01")},{id:"c2",type:"AGENT",name:"Петров Петр Петрович",inn:"771234567890",accountNumber:"40817810200000002345",bik:"044525225",bankName:"ПАО Сбербанк",address:"г. Москва, ул. Агентская, д. 2",offerAcceptedAt:new Date("2024-02-05"),offerAcceptanceChannel:"web",createdAt:new Date("2024-01-20"),updatedAt:new Date("2024-02-05")},{id:"c3",type:"NPD",name:"Сидорова Анна Ивановна",inn:"123456789012",accountNumber:"40817810300000003456",bik:"044525974",bankName:"ПАО ВТБ",address:"г. Санкт-Петербург, пр. Невский, д. 100",offerAcceptedAt:new Date("2024-02-10"),offerAcceptanceChannel:"mobile",createdAt:new Date("2024-01-25"),updatedAt:new Date("2024-02-10")}],c=[{id:"d1",objectName:'ЖК "Солнечный"',objectAddress:"г. Москва, ул. Солнечная, д. 10, корп. 1",lotNumber:"Кв. 45",developerId:"1",totalAmount:15e6,status:"IN_PROGRESS",shares:[{id:"s1",contractorId:"c1",contractor:n[0],role:"AGENCY",sharePercent:60,amount:9e6,taxRegime:"OSN",vatRate:20,contractNumber:"АГ-001/2024",contractDate:new Date("2024-02-01")},{id:"s2",contractorId:"c2",contractor:n[1],role:"AGENT",sharePercent:30,amount:45e5,taxRegime:"USN",contractNumber:"АГ-002/2024",contractDate:new Date("2024-02-05")},{id:"s3",contractorId:"c3",contractor:n[2],role:"NPD",sharePercent:10,amount:15e5,taxRegime:"NPD",contractNumber:"АГ-003/2024",contractDate:new Date("2024-02-10")}],contractBasis:"Договор комиссии",contractNumber:"ДК-2024-001",contractDate:new Date("2024-02-01"),specialAccountReceiptDate:new Date("2024-02-15"),responsibleUserId:"2",initiator:{role:"M2_OPERATOR",partyId:"1",userId:"2",timestamp:new Date("2024-02-01")},createdAt:new Date("2024-02-01"),updatedAt:new Date("2024-02-15")},{id:"d2",objectName:'ЖК "Морской бриз"',objectAddress:"г. Санкт-Петербург, наб. Морская, д. 5",lotNumber:"Кв. 102",developerId:"1",totalAmount:22e6,status:"DRAFT",shares:[{id:"s4",contractorId:"c1",contractor:n[0],role:"AGENCY",sharePercent:70,amount:154e5,taxRegime:"OSN",vatRate:20},{id:"s5",contractorId:"c2",contractor:n[1],role:"AGENT",sharePercent:30,amount:66e5,taxRegime:"USN"}],responsibleUserId:"2",initiator:{role:"AGENCY_ADMIN",partyId:"c1",userId:"3",timestamp:new Date("2024-03-01")},createdAt:new Date("2024-03-01"),updatedAt:new Date("2024-03-01")}],i=[{id:"r1",registryNumber:"РЕЕ-2024-001",date:new Date("2024-03-15"),status:"APPROVED",totalAmount:15e6,linesCount:3,creatorId:"2",approverId:"1",approvedAt:new Date("2024-03-16"),lines:[{id:"l1",registryId:"r1",contractorId:"c1",contractor:n[0],role:"AGENCY",inn:"7701234567",accountNumber:"40702810100000001234",bik:"044525225",amount:9e6,taxRegime:"OSN",vatRate:20,contractNumber:"АГ-001/2024",contractDate:new Date("2024-02-01"),comment:"Комиссия за сделку ЖК Солнечный кв.45",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")},{id:"l2",registryId:"r1",contractorId:"c2",contractor:n[1],role:"AGENT",inn:"771234567890",accountNumber:"40817810200000002345",bik:"044525225",amount:45e5,taxRegime:"USN",contractNumber:"АГ-002/2024",contractDate:new Date("2024-02-05"),comment:"Агентское вознаграждение",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")},{id:"l3",registryId:"r1",contractorId:"c3",contractor:n[2],role:"NPD",inn:"123456789012",accountNumber:"40817810300000003456",bik:"044525974",amount:15e5,taxRegime:"NPD",contractNumber:"АГ-003/2024",contractDate:new Date("2024-02-10"),comment:"Услуги самозанятого",paymentStatus:"PENDING",createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-15")}],createdAt:new Date("2024-03-15"),updatedAt:new Date("2024-03-16")}],s=[{id:"p1",registryId:"r1",lineId:"l1",contractorId:"c1",amount:9e6,status:"EXECUTED",bankReference:"BNK-2024-001",executedAt:new Date("2024-03-17"),createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-17")},{id:"p2",registryId:"r1",lineId:"l2",contractorId:"c2",amount:45e5,status:"ACCEPTED_BY_BANK",bankReference:"BNK-2024-002",createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-16")},{id:"p3",registryId:"r1",lineId:"l3",contractorId:"c3",amount:15e5,status:"ERROR",bankErrorCode:"ERR-01",bankErrorText:"Неверный номер счёта получателя",createdAt:new Date("2024-03-16"),updatedAt:new Date("2024-03-16")}],o={specialAccountBalance:37e6,paidThisPeriod:9e6,pendingPayments:6e6,errorPayments:15e5,primaryDocCompletion:33.33,vatSavings:18e5}},8509:function(e,t,a){"use strict";a.d(t,{W:function(){return i}});var r=a(2141);let n=[];class c{async logEvent(e){let t={id:"evt".concat(Date.now()),type:e.type,entityType:e.entityType,entityId:e.entityId,userId:e.userId,userName:e.userName,userRole:e.userRole,description:e.description,metadata:e.metadata,timestamp:new Date};if(!(0,r.jv)())return n.push(t),console.log("\uD83D\uDCDD Event logged:",t),t;try{let{data:e,error:a}=await r.OQ.from("events").insert([{type:t.type,entity_type:t.entityType,entity_id:t.entityId,user_id:t.userId,user_name:t.userName,user_role:t.userRole,description:t.description,metadata:t.metadata,timestamp:t.timestamp}]).select().single();if(a)throw a;return{...t,id:e.id}}catch(e){return console.error("Failed to log event:",e),n.push(t),t}}async getEventsForEntity(e,t){if(!(0,r.jv)())return n.filter(a=>a.entityType===e&&a.entityId===t).sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime());try{let{data:a,error:n}=await r.OQ.from("events").select("*").eq("entity_type",e).eq("entity_id",t).order("timestamp",{ascending:!1});if(n)throw n;return(a||[]).map(this.mapEvent)}catch(e){return console.error("Failed to fetch events:",e),[]}}async getAllEvents(e){if(!(0,r.jv)()){let t=[...n];return(null==e?void 0:e.entityType)&&(t=t.filter(t=>t.entityType===e.entityType)),(null==e?void 0:e.userId)&&(t=t.filter(t=>t.userId===e.userId)),(null==e?void 0:e.type)&&(t=t.filter(t=>t.type===e.type)),t.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime()),(null==e?void 0:e.limit)&&(t=t.slice(0,e.limit)),t}try{let t=r.OQ.from("events").select("*").order("timestamp",{ascending:!1});(null==e?void 0:e.entityType)&&(t=t.eq("entity_type",e.entityType)),(null==e?void 0:e.userId)&&(t=t.eq("user_id",e.userId)),(null==e?void 0:e.type)&&(t=t.eq("type",e.type)),(null==e?void 0:e.limit)&&(t=t.limit(e.limit));let{data:a,error:n}=await t;if(n)throw n;return(a||[]).map(this.mapEvent)}catch(e){return console.error("Failed to fetch events:",e),[]}}clearEventLog(){n=[]}mapEvent(e){return{id:e.id,type:e.type,entityType:e.entity_type,entityId:e.entity_id,userId:e.user_id,userName:e.user_name,userRole:e.user_role,description:e.description,metadata:e.metadata,timestamp:new Date(e.timestamp)}}}let i=new c},2141:function(e,t,a){"use strict";a.d(t,{OQ:function(){return d},jv:function(){return s}});var r=a(1545),n=a(257);let c=n.env.NEXT_PUBLIC_SUPABASE_URL||"",i=n.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"",s=()=>!!(c&&i),o=null,l=()=>s()?(o||(o=(0,r.eI)(c,i)),o):(console.warn("⚠️ Supabase credentials not configured. Using mock data."),null),d=new Proxy({},{get(e,t){let a=l();if(!a)throw Error("Supabase not configured");return a[t]}})},2660:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},9397:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]])},8930:function(e,t,a){"use strict";a.d(t,{Z:function(){return r}});let r=(0,a(9205).Z)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])}},function(e){e.O(0,[211,545,990,514,971,117,744],function(){return e(e.s=6593)}),_N_E=e.O()}]);